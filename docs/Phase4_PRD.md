# PRD - Product Requirements Document
# Phase 4: Улучшения UX и визуализация данных

**Версия:** 4.0.0  
**Дата:** Январь 2025  
**Статус:** Планирование  
**Предыдущая версия:** Phase 3 v3.0.0

---

## 1. Обзор продукта

### 1.1 Цель

Улучшить пользовательский опыт приложения через современные паттерны UI, добавить визуализацию данных для лучшего понимания прогресса и оптимизировать производительность.

### 1.2 Ключевые улучшения

1. **Современные паттерны UI:**
   - Toast-уведомления вместо alert
   - Улучшенные индикаторы загрузки
   - Оптимистичные обновления UI

2. **Визуализация данных:**
   - Графики веса и КБЖУ
   - Прогресс-бары для визуализации прогресса
   - Улучшенная страница отчетов

3. **Расширенная функциональность:**
   - Экспорт данных
   - Поиск и фильтрация
   - Пагинация

---

## 2. Функциональные спецификации

### 2.1 Система toast-уведомлений

#### 2.1.1 Компонент ToastProvider

**Расположение:** `src/components/ToastProvider.tsx`

**Функциональность:**
- Провайдер для управления toast-уведомлениями
- Интеграция с react-hot-toast
- Настройка позиционирования и стилей

**Интеграция:**
- Добавить в `src/app/layout.tsx` или `src/app/app/layout.tsx`

#### 2.1.2 Замена alert()

**Файлы для обновления:**
- `src/app/app/dashboard/page.tsx`
- `src/app/app/nutrition/page.tsx`
- `src/app/app/coach/[clientId]/page.tsx`
- `src/app/app/settings/page.tsx`
- Все остальные файлы с `alert()`

**Пример замены:**
```typescript
// Было:
alert('Данные сохранены!')

// Стало:
import toast from 'react-hot-toast'
toast.success('Данные сохранены!')
```

---

### 2.2 Индикаторы загрузки

#### 2.2.1 LoadingSpinner

**Компонент:** `src/components/LoadingSpinner.tsx`

**Использование:**
- В кнопках при сохранении
- В модальных окнах
- В небольших элементах UI

**Пример:**
```typescript
<button disabled={loading}>
  {loading ? <LoadingSpinner size="sm" /> : 'Сохранить'}
</button>
```

#### 2.2.2 SkeletonLoader

**Компонент:** `src/components/SkeletonLoader.tsx`

**Варианты:**
- `SkeletonCard` — для карточек
- `SkeletonList` — для списков
- `SkeletonTable` — для таблиц

**Применение:**
- Страница отчетов при загрузке
- Dashboard при загрузке данных
- Списки клиентов у тренера

---

### 2.3 График веса

#### 2.3.1 Компонент WeightChart

**Файл:** `src/components/charts/WeightChart.tsx`

**Props:**
```typescript
interface WeightChartProps {
  data: Array<{ date: string; weight: number }>
  period: '7days' | '30days' | '3months' | 'all'
  onPeriodChange?: (period: string) => void
}
```

**Функциональность:**
- Линейный график с точками данных
- Трендовая линия (линейная регрессия)
- Hover для детальной информации
- Выбор периода через кнопки

**Интеграция:**
- `/app/reports` — вкладка "Графики"
- `/app/dashboard` — секция "Вес" (опционально)

---

### 2.4 Графики КБЖУ

#### 2.4.1 Компонент MacrosChart

**Файл:** `src/components/charts/MacrosChart.tsx`

**Props:**
```typescript
interface MacrosChartProps {
  data: Array<{
    date: string
    calories: number
    protein: number
    fats: number
    carbs: number
    targetCalories?: number
    targetProtein?: number
    targetFats?: number
    targetCarbs?: number
  }>
  period: '7days' | '30days' | '3months' | 'all'
  showTargets?: boolean
}
```

**Функциональность:**
- График калорий (линейный)
- График макронутриентов (столбчатый или линейный)
- Линия цели на графике (если showTargets=true)
- Выбор периода

**Интеграция:**
- `/app/reports` — вкладка "Графики"

---

### 2.5 Прогресс-бары

#### 2.5.1 Компонент ProgressBar

**Файл:** `src/components/ProgressBar.tsx`

**Props:**
```typescript
interface ProgressBarProps {
  label: string
  current: number
  target: number
  unit?: string
  color?: 'green' | 'yellow' | 'red'
  showPercentage?: boolean
}
```

**Функциональность:**
- Визуализация прогресса (current / target)
- Цветовая индикация:
  - Зеленый: 80-100% от цели
  - Желтый: 50-80% от цели
  - Красный: < 50% от цели
- Анимация заполнения
- Отображение процента

**Интеграция:**
- `/app/dashboard` — секция КБЖУ за сегодня
- `/app/nutrition` — отображение прогресса

---

### 2.6 Улучшенная страница отчетов

#### 2.6.1 Структура страницы

**Файл:** `src/app/app/reports/page.tsx`

**Вкладки:**
1. **Графики** — визуализация данных
2. **Таблица** — детальная таблица логов
3. **Статистика** — сводная статистика

#### 2.6.2 Фильтры

**Компонент:** `src/components/reports/ReportFilters.tsx`

**Функциональность:**
- Календарь для выбора диапазона дат
- Выбор типа дня (training/rest/all)
- Сортировка (по дате, калориям, весу)
- Кнопка "Сбросить фильтры"

#### 2.6.3 Группировка данных

- По неделям (текущая реализация)
- По месяцам (новая)
- По годам (новая)
- Переключатель группировки

---

### 2.7 Экспорт данных

#### 2.7.1 Утилиты экспорта

**Файл:** `src/utils/export.ts`

**Функции:**
```typescript
export function exportToCSV(data: DailyLog[], filename: string): void
export function exportToJSON(data: any, filename: string): void
export async function exportToPDF(data: DailyLog[], targets: NutritionTargets): Promise<void>
```

#### 2.7.2 UI для экспорта

**Компонент:** `src/components/reports/ExportButton.tsx`

**Функциональность:**
- Выпадающее меню с форматами
- Выбор периода данных
- Кнопка "Скачать"
- Индикатор загрузки при экспорте PDF

**Интеграция:**
- `/app/reports` — кнопка в header
- `/app/settings` — секция "Экспорт данных"

---

### 2.8 Оптимистичные обновления

#### 2.8.1 Применение

**Сохранение питания:**
```typescript
// Обновляем UI сразу
setMeals([...meals, newMeal])
setTotals(calculateTotals([...meals, newMeal]))

// Отправляем на сервер
const { error } = await supabase.from('daily_logs').upsert(...)

// Откатываем при ошибке
if (error) {
  setMeals(previousMeals)
  setTotals(previousTotals)
  toast.error('Ошибка сохранения')
}
```

**Сохранение заметки тренера:**
- Аналогично, обновляем UI до получения ответа

---

### 2.9 Пагинация

#### 2.9.1 Компонент Pagination

**Файл:** `src/components/Pagination.tsx`

**Props:**
```typescript
interface PaginationProps {
  currentPage: number
  totalPages: number
  onPageChange: (page: number) => void
  itemsPerPage?: number
}
```

**Функциональность:**
- Кнопки "Предыдущая" / "Следующая"
- Номера страниц
- Индикатор текущей страницы
- Переход к первой/последней странице

**Интеграция:**
- `/app/reports` — для таблицы логов
- `/admin` — для списка пользователей

---

## 3. Технические детали

### 3.1 Зависимости

```json
{
  "dependencies": {
    "recharts": "^2.10.0",
    "react-hot-toast": "^2.4.1",
    "papaparse": "^5.4.1",
    "jspdf": "^2.5.1"
  }
}
```

### 3.2 Структура файлов

```
src/
├── components/
│   ├── Toast.tsx (опционально, если нужен кастомный)
│   ├── ToastProvider.tsx
│   ├── LoadingSpinner.tsx
│   ├── SkeletonLoader.tsx
│   ├── ProgressBar.tsx
│   ├── Pagination.tsx
│   ├── charts/
│   │   ├── WeightChart.tsx
│   │   └── MacrosChart.tsx
│   └── reports/
│       ├── ReportFilters.tsx
│       └── ExportButton.tsx
├── utils/
│   └── export.ts
└── app/
    └── app/
        └── reports/
            └── page.tsx (полная переработка)
```

---

## 4. Пользовательские сценарии

### Сценарий 1: Просмотр прогресса веса

**Шаги:**
1. Пользователь открывает `/app/reports`
2. Переходит на вкладку "Графики"
3. Выбирает график "Вес"
4. Выбирает период "30 дней"
5. Видит график с трендовой линией
6. Наводит курсор на точку данных
7. Видит tooltip с датой и весом

**Ожидаемый результат:**
- График отображается корректно
- Трендовая линия показывает общее направление
- Tooltip показывает детальную информацию

---

### Сценарий 2: Экспорт данных в CSV

**Шаги:**
1. Пользователь открывает `/app/reports`
2. Нажимает кнопку "Экспорт"
3. Выбирает формат "CSV"
4. Выбирает период "Последние 30 дней"
5. Нажимает "Скачать"
6. Получает файл `nutrition_data_2025-01-XX.csv`

**Ожидаемый результат:**
- Файл скачивается успешно
- Данные корректно отформатированы
- Можно открыть в Excel

---

### Сценарий 3: Использование toast вместо alert

**Шаги:**
1. Пользователь вводит данные о питании
2. Нажимает "Сохранить"
3. Вместо alert появляется toast "Данные сохранены" (зеленый)
4. Toast автоматически исчезает через 3 секунды

**Ожидаемый результат:**
- Toast появляется в правом верхнем углу
- Имеет зеленый цвет (success)
- Автоматически исчезает
- Можно закрыть вручную

---

## 5. Метрики успеха

### Количественные:
- Увеличение времени на сайте на 20%+
- Увеличение частоты использования отчетов на 30%+
- Снижение времени загрузки страниц на 15%+
- Увеличение экспорта данных на 50%+

### Качественные:
- Улучшение восприятия скорости работы
- Повышение вовлеченности через визуализацию
- Улучшение UX через современные паттерны

---

## 6. Известные ограничения

1. **Графики:** Требуют библиотеку recharts (увеличивает размер bundle на ~200KB)
2. **PDF экспорт:** Требует дополнительную библиотеку jspdf (~100KB)
3. **Производительность:** При большом количестве данных (>365 точек) графики могут быть медленными

---

## 7. Риски и митигация

### Риск 1: Большие библиотеки
**Митигация:** Code splitting, lazy loading компонентов графиков

### Риск 2: Производительность графиков
**Митигация:** Ограничение данных (максимум 365 точек), агрегация данных

### Риск 3: Сложность интеграции
**Митигация:** Использовать готовые библиотеки, постепенная миграция

---

**Конец документации Phase 4 PRD**

