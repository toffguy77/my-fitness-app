# BRD - Business Requirements Document
# Phase 2.5: Business Logic & Access Control (Freemium SaaS)

**Версия:** 2.5.0  
**Дата:** Декабрь 2025  
**Статус:** В разработке  
**Предыдущая версия:** Phase 2 v2.0.0

---

## 1. Бизнес-контекст

### 1.1 Фундаментальный сдвиг бизнес-модели

**От:** Простой инструмент для отслеживания питания  
**К:** Freemium SaaS платформа с монетизацией

### 1.2 Проблема текущей модели

- Приложение полностью закрыто (требует авторизацию)
- Нет способа привлечь новых пользователей
- Нет разделения между бесплатным и платным функционалом
- Нет инструментов для управления подписками
- Нет супер-админки для управления бизнесом

### 1.3 Целевая бизнес-модель

**Freemium модель:**
- **Free:** Базовый дневник питания (привлечение пользователей)
- **Premium:** Полный функционал с тренером (монетизация)

**Роли:**
- **Клиент (Free):** Использует дневник бесплатно
- **Клиент (Premium):** Подписка с тренером, отчеты, OCR, чат
- **Тренер:** Работает с Premium клиентами
- **Супер-админ:** Управление всей платформой

---

## 2. Функциональные требования

### 2.1 Публичный лендинг

**Требование:** Открыть приложение для всех без авторизации.

**Функциональность:**
- ✅ Маркетинговая страница на `/`
- ✅ Информация о продукте
- ✅ Call-to-action: "Начать бесплатно" → `/register`
- ✅ Скриншоты/демо функционала
- ✅ Преимущества использования

**Бизнес-ценность:**
- Привлечение новых пользователей (Top of Funnel)
- SEO-оптимизация
- Конверсия посетителей в регистрации

**Приоритет:** Критический

---

### 2.2 Регистрация только как клиент

**Требование:** Убрать выбор роли при регистрации.

**Функциональность:**
- ✅ Форма регистрации только для роли "client"
- ✅ Автоматическое создание профиля с `role = 'client'`
- ✅ Дефолтные значения: `subscription_status = 'free'`, `subscription_tier = 'basic'`
- ✅ Редирект на `/app/dashboard` после регистрации

**Бизнес-ценность:**
- Упрощение процесса регистрации
- Снижение барьера входа
- Больше конверсий

**Приоритет:** Критический

---

### 2.3 Новая структура маршрутов

**Требование:** Реорганизовать маршруты для разделения публичной и приватной зон.

**Структура:**
```
/                    → Лендинг (публичный)
/login               → Авторизация
/register            → Регистрация (только client)
/app                 → Защищенная зона приложения
  /dashboard         → Дневник (доступен всем авторизованным)
  /nutrition         → Ввод питания (доступен всем)
  /reports           → Отчеты (только Premium)
  /coach             → Кабинет тренера (только coach)
/admin               → Супер-админка (только super_admin)
```

**Бизнес-ценность:**
- Четкое разделение зон
- Улучшенная навигация
- Гибкость для будущих расширений

**Приоритет:** Критический

---

### 2.4 Супер-админка

**Требование:** Создать панель управления для супер-админа.

**Функциональность:**

#### 2.4.1 Управление пользователями
- ✅ Таблица всех пользователей
- ✅ Поиск по email/имени
- ✅ Фильтры: роль, статус подписки
- ✅ Сортировка

#### 2.4.2 Редактирование профилей
- ✅ Изменение роли (Client ↔ Coach)
- ✅ Назначение тренера клиенту (`coach_id`)
- ✅ Управление подпиской:
  - Статус: `free` → `active` → `cancelled` → `past_due`
  - Уровень: `basic` → `premium`
  - Даты начала/окончания подписки
- ✅ Сохранение изменений

#### 2.4.3 CRUD операции
- ✅ Создание пользователей (вручную)
- ✅ Редактирование всех полей
- ✅ Удаление пользователей (с подтверждением)

**Бизнес-ценность:**
- Полный контроль над платформой
- Управление подписками без интеграции платежей (MVP)
- Масштабируемость бизнеса

**Приоритет:** Критический

---

### 2.5 Feature Gating (Закрытие фич)

**Требование:** Разделить функционал между Free и Premium пользователями.

**Логика:**

#### 2.5.1 Доступные всем (Free)
- ✅ Дневник питания (`/app/nutrition`)
- ✅ Базовый дашборд (`/app/dashboard`)
- ✅ Просмотр своих данных

#### 2.5.2 Только Premium
- ✅ Отчеты и аналитика (`/app/reports`)
- ✅ Корректировки питания от тренера
- ✅ OCR фичи (будущее)
- ✅ Чат с тренером (будущее)
- ✅ Расширенная аналитика

**Реализация:**
- Проверка `subscription_status === 'active'` и `subscription_tier === 'premium'`
- Paywall компонент для заблокированных фич
- Баннеры с призывом к подписке

**Бизнес-ценность:**
- Мотивация к подписке
- Четкое разделение ценности
- Конверсия Free → Premium

**Приоритет:** Высокий

---

## 3. Технические требования

### 3.1 Обновление схемы БД

**Таблица `profiles`:**
```sql
ALTER TABLE profiles 
ADD COLUMN subscription_status TEXT DEFAULT 'free' 
  CHECK (subscription_status IN ('free', 'active', 'cancelled', 'past_due')),
ADD COLUMN subscription_tier TEXT DEFAULT 'basic' 
  CHECK (subscription_tier IN ('basic', 'premium')),
ADD COLUMN subscription_start_date TIMESTAMPTZ,
ADD COLUMN subscription_end_date TIMESTAMPTZ;
```

**Enum `user_role`:**
```sql
ALTER TYPE user_role ADD VALUE 'super_admin';
```

**Приоритет:** Критический

---

### 3.2 RLS Policies для Super Admin

**Требование:** Супер-админ имеет полный доступ ко всем данным.

**Политики:**
- `SELECT`: Супер-админ видит все записи
- `INSERT`: Супер-админ может создавать записи
- `UPDATE`: Супер-админ может обновлять все записи
- `DELETE`: Супер-админ может удалять записи

**Проверка:**
```sql
EXISTS (
  SELECT 1 FROM profiles p
  WHERE p.id = auth.uid()
  AND p.role = 'super_admin'
)
```

**Приоритет:** Критический

---

### 3.3 Middleware обновления

**Требование:** Обновить роутинг для новой структуры.

**Логика:**
- `/` → Публичный доступ (лендинг)
- `/app/*` → Требует авторизации
- `/admin/*` → Требует роль `super_admin`
- `/app/coach/*` → Требует роль `coach`
- `/app/reports` → Требует `subscription_status = 'active'`

**Приоритет:** Критический

---

## 4. Пользовательские сценарии

### Сценарий 1: Новый пользователь
1. Заходит на `/` (лендинг)
2. Читает информацию о продукте
3. Нажимает "Начать бесплатно"
4. Регистрируется (`/register`)
5. Автоматически создается профиль с `role = 'client'`, `subscription_status = 'free'`
6. Редирект на `/app/dashboard`
7. Видит базовый функционал (дневник доступен)
8. Пытается зайти в `/app/reports` → Видит paywall

### Сценарий 2: Активация подписки (ручная)
1. Клиент платит деньги (вне системы)
2. Супер-админ заходит в `/admin`
3. Находит клиента по email
4. Меняет `subscription_status` на `active`
5. Меняет `subscription_tier` на `premium`
6. Назначает `coach_id`
7. Устанавливает даты подписки
8. Сохраняет
9. Клиент обновляет страницу → Видит полный функционал

### Сценарий 3: Супер-админ управляет платформой
1. Входит в `/admin`
2. Видит таблицу всех пользователей
3. Фильтрует по статусу подписки
4. Редактирует профиль клиента
5. Активирует подписку
6. Назначает тренера
7. Сохраняет изменения

---

## 5. Метрики успеха

### Количественные метрики:
- Количество регистраций через лендинг
- Конверсия Free → Premium
- Количество активных подписок
- Время до активации подписки

### Качественные метрики:
- Удобство управления подписками для админа
- Понятность paywall для пользователей
- Мотивация к подписке через ограничения

---

## 6. Известные ограничения

1. **Нет интеграции платежей:** Подписки активируются вручную
2. **Нет автоматического продления:** Требуется ручное управление
3. **Нет уведомлений:** О скором окончании подписки
4. **OCR и Чат:** Не реализованы (будущее)

---

## 7. Риски и митигация

### Риск 1: Сложность управления подписками вручную
**Митигация:** Удобный интерфейс админки, четкие инструкции

### Риск 2: Пользователи обходят paywall
**Митигация:** Проверки на сервере (RLS), валидация на клиенте

### Риск 3: Потеря данных при миграции
**Митигация:** Backup перед миграцией, тестирование на dev окружении

---

## 8. План реализации

### Шаг 1: База данных и типы (1 день)
- ✅ SQL миграции для обновления схемы
- ✅ Обновление TypeScript типов
- ✅ Обновление RLS policies

### Шаг 2: Middleware и лендинг (1-2 дня)
- ✅ Создание лендинга на `/`
- ✅ Перенос дашборда в `/app/dashboard`
- ✅ Обновление middleware

### Шаг 3: Супер-админка (2 дня)
- ✅ Страница `/admin`
- ✅ Таблица пользователей
- ✅ Форма редактирования
- ✅ CRUD операции

### Шаг 4: Feature Gating (1 день)
- ✅ Paywall компонент
- ✅ Проверки доступа
- ✅ Баннеры с призывом к подписке

---

**Конец документации Phase 2.5**

