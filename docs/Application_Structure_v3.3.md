# Структура приложения My Fitness App v3.3

## Обзор

My Fitness App — это Freemium SaaS платформа для управления питанием и отслеживания прогресса. Документация v3.3 отражает **текущую реализацию** в коде (по состоянию на январь 2025) с добавлением **системы уведомлений, валидации данных и автоматической деактивации подписок**.

---

## Ключевые изменения v3.3

1. **Система email-уведомлений:** Интеграция Resend API для отправки уведомлений пользователям
2. **Валидация данных о питании:** Клиентская и серверная валидация с предупреждениями
3. **Автоматическая деактивация подписок:** Cron jobs для проверки и деактивации истекших подписок
4. **Обновленная логика подписок:** Проверка `subscription_end_date` при определении активной подписки

---

## Роли пользователей

*Без изменений по сравнению с v3.2: Client (Free/Premium), Coach, Super Admin*

---

## Публичные страницы (не требуют авторизации)

*Без изменений по сравнению с v3.2: `/`, `/login`, `/register`*

---

## Защищенные страницы для клиентов

### `/onboarding` — Мастер настройки

**Файл:** `src/app/onboarding/page.tsx`

**Функциональность:**
- *Без изменений в v3.3*
- 3 шага: Биометрия, Активность, Цель
- Расчет BMR/TDEE и создание целей

**Переходы:**
- → `/app/dashboard` (после завершения)

---

### `/app/dashboard` — Дашборд клиента

**Файл:** `src/app/app/dashboard/page.tsx`

**Изменения в v3.3:**

#### 1. Валидация данных при добавлении приемов пищи (NEW)
- **Компонент:** `AddMealModal`
- **Функциональность:**
  - Валидация в реальном времени при вводе данных
  - Предупреждения о превышении лимитов
  - Проверка соответствия калорий макронутриентам
  - Блокировка сохранения при критических ошибках
  - Отображение предупреждений через компонент `ValidationWarning`

**Остальная функциональность:**
- *Без изменений по сравнению с v3.2*

**Переходы:**
- → `/app/settings` (кнопка "Настройки")
- → `/app/nutrition?date={selectedDate}` (ввод/редактирование питания, только если день не завершен)
- → `/app/reports` (отчеты — только Premium)

---

### `/app/nutrition` — Ввод данных о питании

**Файл:** `src/app/app/nutrition/page.tsx`

**Изменения в v3.3:**

#### 1. Валидация данных о питании (NEW)
- **Клиентская валидация:**
  - Проверка максимальных значений для каждого приема пищи
  - Проверка соответствия калорий макронутриентам
  - Предупреждения в реальном времени
  - Валидация дневных totals перед сохранением
- **Отображение:**
  - Компонент `ValidationWarning` для каждого приема пищи
  - Валидация дневных totals внизу формы
  - Блокировка сохранения при критических ошибках

**Остальная функциональность:**
- *Без изменений по сравнению с v3.2*

**Переходы:**
- → `/app/dashboard?date={selectedDate}` (после сохранения или если день завершен)
- → `/login` (если пользователь не авторизован)

**Особенности:**
- Валидация не блокирует сохранение при предупреждениях (только при ошибках)
- Предупреждения о несоответствии калорий макронутриентам показываются, но не блокируют

---

### `/app/reports` — Отчеты и аналитика (только Premium)

**Файл:** `src/app/app/reports/page.tsx`

**Функциональность:**
- *Без изменений в v3.3*
- Группировка логов по неделям
- Отображение КБЖУ, веса, заметок

**Переходы:**
- → `/app/dashboard` (кнопка "← Назад")

---

### `/app/settings` — Настройки профиля

**Файл:** `src/app/app/settings/page.tsx`

**Функциональность:**
- *Без изменений в v3.3*
- Редактирование профиля (имя, телефон)
- Смена пароля
- Просмотр статуса подписки
- Информация о тренере (для Premium)
- Пересчет целей по текущему весу
- Выход из системы

**Переходы:**
- → `/app/dashboard` (кнопка "Назад")
- → `/onboarding` (если нет биометрических данных при пересчете)
- → `/login` (после выхода)

---

## Защищенные страницы для тренеров

### `/app/coach` — Кабинет тренера

**Файл:** `src/app/app/coach/page.tsx`

**Функциональность:**
- *Без изменений в v3.3*
- Список клиентов с информацией о последнем чекине
- Отображение калорий за сегодня vs цель
- Traffic Light System v2 для статусов клиентов
- Переход к просмотру дашборда клиента

**Переходы:**
- → `/app/coach/[clientId]` (клик по клиенту)
- → `/login` (кнопка выхода)

---

### `/app/coach/[clientId]` — Просмотр дашборда клиента

**Файл:** `src/app/app/coach/[clientId]/page.tsx`

**Изменения в v3.3:**

#### 1. Email уведомление при сохранении заметки (NEW)
- **Функциональность:**
  - После успешного сохранения заметки отправляется email уведомление клиенту
  - Вызов Supabase Edge Function `send-notification`
  - Email содержит текст заметки и ссылку на дашборд
  - Ошибки отправки email не блокируют сохранение заметки

**Остальная функциональность:**
- *Без изменений по сравнению с v3.2*

**Переходы:**
- → `/app/coach` (кнопка "Назад")

**Особенности:**
- Email уведомление отправляется асинхронно
- Ошибки отправки логируются, но не влияют на сохранение заметки

---

## Защищенные страницы для супер-администраторов

### `/admin` — Панель супер-администратора

**Файл:** `src/app/admin/page.tsx`

**Функциональность:**
- *Без изменений в v3.3*
- Управление пользователями
- Редактирование ролей, подписок, назначение тренеров

**Переходы:**
- → `/login` (кнопка выхода)

---

## Система навигации и защиты маршрутов

### Middleware (`src/middleware.ts`)

**Функциональность:**
- *Без изменений в v3.3*
- Защита `/onboarding` (только авторизованные)
- Защита `/app/reports` (только Premium)
- Защита `/app/coach` (только тренеры)
- Защита `/admin` (только super_admin)

---

## Особенности реализации v3.3

### Система email-уведомлений

1. **Интеграция Resend API:**
   - Утилита `src/utils/email.ts` для отправки email
   - Supabase Edge Function `send-notification` для серверной отправки
   - Шаблоны для разных типов уведомлений

2. **Типы уведомлений:**
   - Напоминание о вводе данных (`reminder_data_entry`)
   - Уведомление о заметке тренера (`coach_note_notification`)
   - Предупреждение об истечении подписки (`subscription_expiring`)
   - Уведомление об истечении подписки (`subscription_expired`)

3. **Триггеры отправки:**
   - При сохранении заметки тренером → уведомление клиенту
   - Ежедневно в 20:00 → напоминание о вводе данных (планируется)
   - Ежедневно в 00:00 UTC → проверка истекших подписок

### Валидация данных о питании

1. **Клиентская валидация:**
   - Утилиты валидации в `src/utils/validation/nutrition.ts`
   - Компонент `ValidationWarning` для отображения предупреждений
   - Валидация в реальном времени при вводе данных
   - Проверка максимальных значений и соответствия калорий макронутриентам

2. **Серверная валидация:**
   - PostgreSQL функции валидации в миграции `v3.3_add_validation_and_notifications.sql`
   - Триггеры для проверки при сохранении `daily_logs`
   - Блокировка сохранения при превышении лимитов
   - Предупреждения (не блокировка) при несоответствии калорий

3. **Лимиты валидации:**
   - Максимум калорий в день: 10000 ккал
   - Максимум калорий на прием пищи: 5000 ккал
   - Максимум белков: 1000г
   - Максимум жиров: 500г
   - Максимум углеводов: 1500г
   - Допустимая погрешность калорий: 50 ккал

### Автоматическая деактивация подписок

1. **Проверка истекших подписок:**
   - Supabase Edge Function `check-expired-subscriptions`
   - Вызов через cron job ежедневно в 00:00 UTC
   - Использование PostgreSQL функции `deactivate_expired_subscriptions()`
   - Отправка email уведомлений об истечении

2. **Предупреждения об истечении:**
   - Supabase Edge Function `check-expiring-subscriptions`
   - Вызов через cron job ежедневно
   - Проверка подписок, истекающих через 3 дня
   - Отправка email предупреждений

3. **Обновленная логика проверки:**
   - Функция `hasActiveSubscription()` проверяет `subscription_end_date`
   - Если `subscription_end_date < NOW()`, возвращает `false`
   - Функция `isPremium()` также проверяет дату истечения

---

## Технические детали

### Используемые технологии

- **Frontend:** Next.js 16 (App Router), React 19, Tailwind CSS v4
- **Backend:** Supabase (Authentication, Database, RLS, Edge Functions)
- **Email:** Resend API
- **State Management:** React Hooks (useState, useEffect, useMemo)
- **Routing:** Next.js App Router с middleware для защиты маршрутов
- **Icons:** Lucide React

### База данных

#### Новые функции PostgreSQL (v3.3):
- `validate_calories_match_macros()` - проверка соответствия калорий макронутриентам
- `validate_nutrition_limits()` - проверка максимальных значений
- `get_expired_subscriptions()` - получение истекших подписок
- `get_expiring_subscriptions()` - получение подписок, истекающих через N дней
- `deactivate_expired_subscriptions()` - деактивация истекших подписок

#### Новые триггеры (v3.3):
- `nutrition_validation_trigger` - валидация данных при сохранении `daily_logs`

#### Новые индексы (v3.3):
- `idx_daily_logs_user_date` - для быстрого поиска логов по пользователю и дате
- `idx_daily_logs_is_completed` - для фильтрации завершенных дней

#### Миграция:
- Файл: `docs/migrations/v3.3_add_validation_and_notifications.sql`
- Добавляет функции валидации, триггеры и функции для работы с подписками

### Supabase Edge Functions

#### `send-notification`
- **Расположение:** `supabase/functions/send-notification/index.ts`
- **Назначение:** Отправка email уведомлений через Resend API
- **Параметры:** `userId`, `template`, `data`
- **Использование:** Вызывается из клиентского кода при необходимости отправки уведомления

#### `check-expired-subscriptions`
- **Расположение:** `supabase/functions/check-expired-subscriptions/index.ts`
- **Назначение:** Проверка и деактивация истекших подписок
- **Использование:** Вызывается через cron job ежедневно в 00:00 UTC

#### `check-expiring-subscriptions`
- **Расположение:** `supabase/functions/check-expiring-subscriptions/index.ts`
- **Назначение:** Проверка подписок, истекающих через N дней
- **Параметры:** `daysAhead` (по умолчанию 3)
- **Использование:** Вызывается через cron job ежедневно

### Безопасность

- **Row Level Security (RLS)** в Supabase для всех таблиц
- **Валидация на уровне БД:** Триггеры предотвращают сохранение некорректных данных
- **Проверка подписок:** Логика проверки `subscription_end_date` предотвращает доступ к Premium функциям без оплаты

### Адаптивность

- **Mobile First подход:** Все новые компоненты адаптивны
- Компонент `ValidationWarning` адаптивен
- Email шаблоны поддерживают мобильные устройства

---

## Компоненты

### `DayToggle` (`src/components/DayToggle.tsx`)
- *Без изменений в v3.3*

### `Paywall` (`src/components/Paywall.tsx`)
- *Без изменений в v3.3*

### `ClientDashboardView` (`src/components/ClientDashboardView.tsx`)
- *Без изменений в v3.3*

### `ValidationWarning` (`src/components/ValidationWarning.tsx`) (NEW)
- **Функциональность:**
  - Отображение ошибок и предупреждений валидации
  - Поддержка inline версии для форм
  - Возможность закрытия предупреждений
  - Адаптивный дизайн

### `AddMealModal` (встроенный компонент в `src/app/app/dashboard/page.tsx`)
- **Изменения в v3.3:**
  - Добавлена валидация при вводе данных
  - Отображение предупреждений через `ValidationWarning`
  - Блокировка сохранения при критических ошибках

---

## Утилиты

### `src/utils/validation/nutrition.ts` (NEW)
- **Функциональность:**
  - Константы лимитов валидации
  - Функции проверки соответствия калорий макронутриентам
  - Функции проверки максимальных значений
  - Валидация приемов пищи и дневных totals

### `src/utils/email.ts` (NEW)
- **Функциональность:**
  - Отправка email уведомлений через Resend API
  - Шаблоны для разных типов уведомлений
  - Обработка ошибок и логирование

### `src/utils/supabase/profile.ts`
- **Изменения в v3.3:**
  - Функция `hasActiveSubscription()` проверяет `subscription_end_date`
  - Функция `isPremium()` проверяет дату истечения подписки

---

## Примечания

1. **Email уведомления:** Требуют настройки Resend API и переменных окружения
2. **Cron jobs:** Требуют настройки в Supabase Dashboard для автоматического запуска
3. **Валидация:** Предупреждения о несоответствии калорий не блокируют сохранение (только предупреждают)
4. **Автоматическая деактивация:** Подписки деактивируются автоматически при истечении, но требуют настройки cron jobs
5. **Миграция БД:** Необходимо выполнить `docs/migrations/v3.3_add_validation_and_notifications.sql` перед использованием новых функций

---

## Переменные окружения

Добавлены новые переменные окружения для email уведомлений:

```
RESEND_API_KEY=re_xxxxx
RESEND_FROM_EMAIL=Fitness App <noreply@yourdomain.com>
NEXT_PUBLIC_APP_URL=http://localhost:3069
```

---

*Документ обновлен: Январь 2025 (на основе текущей реализации в коде v3.3)*

