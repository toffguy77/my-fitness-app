# BRD - Business Requirements Document
# Phase 3: Уведомления, валидация данных, автоматическая деактивация подписок

**Версия:** 3.0.0  
**Дата:** Январь 2025  
**Статус:** Завершено  
**Предыдущая версия:** Phase 2.6 v2.6.0

---

## 1. Бизнес-контекст

### 1.1 Проблема текущей реализации

После Phase 2.6 были выявлены следующие проблемы:

1. **Отсутствие уведомлений:**
   - Пользователи забывают вводить данные о питании
   - Клиенты не знают, когда тренер оставляет заметки
   - Нет предупреждений об истечении подписки

2. **Отсутствие валидации данных:**
   - Можно ввести нереалистичные значения (например, 100000 ккал)
   - Нет проверки соответствия калорий макронутриентам
   - Накопление некорректных данных в системе

3. **Ручное управление подписками:**
   - Подписки не деактивируются автоматически при истечении
   - Нет предупреждений об истечении подписки
   - Риск доступа к Premium функциям без оплаты

### 1.2 Целевое состояние

**Улучшенная вовлеченность:**
- Email уведомления напоминают о важных действиях
- Клиенты получают уведомления о заметках тренера
- Предупреждения об истечении подписки

**Качество данных:**
- Валидация на клиенте и сервере
- Предупреждения о несоответствиях
- Защита от некорректных данных

**Автоматизация:**
- Автоматическая деактивация истекших подписок
- Предупреждения об истечении за 3 дня
- Меньше ручной работы для администраторов

---

## 2. Функциональные требования

### 2.1 Система email-уведомлений

**Требование:** Реализовать систему email уведомлений через Resend API.

#### 2.1.1 Типы уведомлений

1. **Напоминание о вводе данных** (`reminder_data_entry`)
   - Когда: ежедневно в 20:00 для пользователей без данных за сегодня
   - Текст: "Не забудьте внести данные о питании за сегодня"
   - Приоритет: Средний

2. **Уведомление о заметке тренера** (`coach_note_notification`)
   - Когда: сразу после сохранения заметки тренером
   - Текст: "Ваш тренер оставил заметку за [дата]"
   - Приоритет: Высокий

3. **Предупреждение об истечении подписки** (`subscription_expiring`)
   - Когда: за 3 дня до истечения
   - Текст: "Ваша Premium подписка истекает через 3 дня"
   - Приоритет: Высокий

4. **Уведомление об истечении подписки** (`subscription_expired`)
   - Когда: в день истечения
   - Текст: "Ваша Premium подписка истекла"
   - Приоритет: Критический

#### 2.1.2 Реализация

- Supabase Edge Function для отправки email
- Интеграция Resend API
- Шаблоны email с HTML и текстовой версией
- Обработка ошибок и логирование

**Приоритет:** Высокий

---

### 2.2 Валидация данных о питании

**Требование:** Добавить валидацию данных о питании на клиенте и сервере.

#### 2.2.1 Клиентская валидация

**Функциональность:**
- Проверка максимальных значений (калории, белки, жиры, углеводы)
- Проверка соответствия калорий макронутриентам
- Предупреждения в реальном времени при вводе
- Блокировка сохранения при критических ошибках

**Лимиты:**
- Максимум калорий в день: 10000 ккал
- Максимум калорий на прием пищи: 5000 ккал
- Максимум белков: 1000г
- Максимум жиров: 500г
- Максимум углеводов: 1500г
- Допустимая погрешность калорий: 50 ккал

**Приоритет:** Высокий

#### 2.2.2 Серверная валидация

**Функциональность:**
- PostgreSQL функции валидации
- Триггеры для проверки при сохранении
- Предупреждения вместо блокировки (для соответствия калорий)
- Блокировка при превышении лимитов

**Приоритет:** Критический

---

### 2.3 Автоматическая деактивация подписок

**Требование:** Автоматически деактивировать истекшие подписки и отправлять уведомления.

#### 2.3.1 Проверка истекших подписок

**Функциональность:**
- Supabase Edge Function для проверки подписок
- Вызов через cron job ежедневно в 00:00 UTC
- Поиск подписок с `subscription_end_date < NOW()`
- Обновление статуса на `'cancelled'`
- Отправка email уведомлений

**Приоритет:** Критический

#### 2.3.2 Предупреждения об истечении

**Функциональность:**
- Edge Function для проверки подписок, истекающих через 3 дня
- Вызов через cron job ежедневно
- Отправка email предупреждений

**Приоритет:** Высокий

#### 2.3.3 Обновление логики проверки подписки

**Функциональность:**
- Функция `hasActiveSubscription()` проверяет `subscription_end_date`
- Если `subscription_end_date < NOW()`, возвращает `false`
- Обновление функции `isPremium()` для проверки даты

**Приоритет:** Критический

---

## 3. Технические требования

### 3.1 Зависимости

- `resend` - для отправки email уведомлений

### 3.2 Переменные окружения

```
RESEND_API_KEY=re_xxxxx
RESEND_FROM_EMAIL=Fitness App <noreply@yourdomain.com>
NEXT_PUBLIC_APP_URL=http://localhost:3069
```

### 3.3 Supabase Edge Functions

1. `send-notification` - отправка email уведомлений
2. `check-expired-subscriptions` - проверка и деактивация истекших подписок
3. `check-expiring-subscriptions` - проверка подписок, истекающих через N дней

### 3.4 Миграции БД

**Файл:** `docs/migrations/v3.3_add_validation_and_notifications.sql`

**Содержимое:**
- Функции валидации данных о питании
- Триггеры для проверки при сохранении
- Функции для работы с подписками
- Индексы для производительности

---

## 4. Пользовательские сценарии

### Сценарий 1: Клиент получает уведомление о заметке тренера

1. Тренер сохраняет заметку для клиента
2. Edge Function отправляет email уведомление
3. Клиент получает email с текстом заметки
4. Клиент переходит по ссылке в дашборд

### Сценарий 2: Валидация данных при вводе

1. Клиент вводит данные о приеме пищи
2. Система проверяет значения в реальном времени
3. Показываются предупреждения при несоответствиях
4. Сохранение блокируется при критических ошибках

### Сценарий 3: Автоматическая деактивация подписки

1. Cron job запускается ежедневно в 00:00 UTC
2. Находятся подписки с истекшей датой
3. Статус обновляется на `'cancelled'`
4. Отправляются email уведомления клиентам
5. При следующем входе клиент видит Free функционал

---

## 5. Метрики успеха

### Количественные метрики:
- Увеличение частоты ввода данных после напоминаний
- Снижение количества некорректных данных
- Автоматическая деактивация 100% истекших подписок

### Качественные метрики:
- Улучшение качества данных благодаря валидации
- Повышение вовлеченности через уведомления
- Снижение ручной работы администраторов

---

## 6. Известные ограничения

1. **Email уведомления:** Требуют настройки Resend API
2. **Cron jobs:** Требуют настройки в Supabase Dashboard
3. **Валидация:** Предупреждения о несоответствии калорий не блокируют сохранение (только предупреждают)

---

## 7. Риски и митигация

### Риск 1: Resend API лимиты
**Митигация:** Мониторинг использования, обработка ошибок, fallback на логирование

### Риск 2: Cron jobs могут не запускаться
**Митигация:** Логирование, мониторинг, ручной запуск через Supabase Dashboard

### Риск 3: Валидация может блокировать легитимные данные
**Митигация:** Предупреждения вместо блокировки для соответствия калорий, только критичные ошибки блокируют сохранение

---

## 8. План реализации

### Неделя 1-2: Валидация данных
1. Создать утилиты валидации
2. Добавить клиентскую валидацию в формы
3. Создать компонент ValidationWarning
4. Написать тесты валидации

### Неделя 3-4: Email уведомления
1. Настроить Resend API
2. Создать утилиту отправки email
3. Создать Supabase Edge Function для отправки
4. Интегрировать уведомления в существующий код
5. Написать тесты

### Неделя 5-6: Деактивация подписок
1. Создать Edge Function для проверки подписок
2. Настроить cron job в Supabase
3. Обновить логику проверки подписки
4. Добавить предупреждения об истечении
5. Написать тесты

### Неделя 7-8: Финальная полировка
1. Интеграционное тестирование
2. Обновление документации
3. Миграции БД
4. Code review и рефакторинг

---

**Конец документации Phase 3**

