# Структура приложения My Fitness App v3.1

## Обзор

My Fitness App — это Freemium SaaS платформа для управления питанием и отслеживания прогресса. Документация v3.1 отражает **текущую реализацию** в коде (по состоянию на 17 декабря 2025) с добавлением **Onboarding**, **навигации по датам** и **умного копирования приемов пищи**.

---

## Ключевые изменения v3.1

1. **Onboarding Wizard:** Автоматический расчет КБЖУ для новых пользователей на основе биометрических данных
2. **Date Navigation:** Возможность просмотра и редактирования данных за прошлые дни
3. **Smart Defaults & Copy:** Копирование приемов пищи из вчерашнего дня и список недавних продуктов
4. **Расширенная модель данных:** Добавлены поля для биометрии и активности пользователя

---

## Роли пользователей

*Без изменений по сравнению с v3.0: Client (Free/Premium), Coach, Super Admin*

---

## Публичные страницы (не требуют авторизации)

### `/` — Landing Page (Главная страница)

**Файл:** `src/app/page.tsx`

**Функциональность:**
- Маркетинговая страница с описанием приложения
- Секции: Hero, The Problem, The Solution, The Hook, Footer

**Переходы:**
- → `/register` (кнопка "Начать бесплатно")
- → `/login` (для авторизованных пользователей — автоматический редирект)

---

### `/login` — Страница входа

**Файл:** `src/app/login/page.tsx`

**Функциональность:**
- Авторизация существующих пользователей
- Автоматический редирект на соответствующую страницу по роли

**Переходы:**
- → `/app/dashboard` (для клиентов)
- → `/app/coach` (для тренеров)
- → `/admin` (для super_admin)
- → `/register` (ссылка "Нет аккаунта?")

---

### `/register` — Страница регистрации

**Файл:** `src/app/register/page.tsx`

**Функциональность:**
- Регистрация новых пользователей
- Автоматическое создание профиля с ролью `client` и статусом `free`

**Переходы:**
- → `/onboarding` (после успешной регистрации — автоматический редирект, если нет целей)
- → `/app/dashboard` (если цели уже есть)

---

## Защищенные страницы для клиентов

### `/onboarding` — Мастер настройки (NEW в v3.1)

**Файл:** `src/app/onboarding/page.tsx`

**Функциональность:**

#### Логика доступа:
- Открывается автоматически после регистрации, если у пользователя нет целей в `nutrition_targets`
- Если цели уже есть, автоматический редирект на `/app/dashboard`
- Доступна только авторизованным пользователям (защищено middleware)

#### Шаги мастера:

**Step 1: Биометрия**
- Пол: Мужской / Женский / Другое
- Дата рождения (date input)
- Рост (см): 100-250
- Текущий вес (кг): 30-300, шаг 0.1

**Step 2: Активность**
- Сидячий образ жизни (коэффициент 1.2)
- Легкая активность (1.375) — 1-3 тренировки в неделю
- Умеренная активность (1.55) — 3-5 тренировок в неделю
- Высокая активность (1.725) — 6-7 тренировок в неделю
- Очень высокая активность (1.9) — 2 тренировки в день

**Step 3: Цель**
- Похудеть (дефицит -15%)
- Поддержать вес (баланс)
- Набрать вес (профицит +10%)

#### Расчет целей:
- **BMR (Basal Metabolic Rate):** Формула Харриса-Бенедикта
  - Мужчины: `88.362 + (13.397 × вес) + (4.799 × рост) - (5.677 × возраст)`
  - Женщины: `447.593 + (9.247 × вес) + (3.098 × рост) - (4.330 × возраст)`
- **TDEE (Total Daily Energy Expenditure):** `BMR × коэффициент активности`
- **Целевые калории:** TDEE с учетом цели (дефицит/профицит)
- **Макронутриенты:** Стандартное распределение (30% белки, 25% жиры, 45% углеводы)

#### Сохранение данных:
1. Биометрические данные сохраняются в `profiles` (gender, birth_date, height, activity_level)
2. Создаются две записи в `nutrition_targets`:
   - `day_type: 'rest'` — базовая цель (рассчитанная)
   - `day_type: 'training'` — цель для тренировочного дня (+200 ккал)
3. Сохраняется начальный вес в `daily_logs` за сегодня

**Переходы:**
- → `/app/dashboard` (после завершения настройки)
- → `/login` (если пользователь не авторизован)

**Особенности:**
- Прогресс-бар показывает текущий шаг (1/3, 2/3, 3/3)
- Предварительный расчет отображается на Step 3 перед сохранением
- Валидация всех полей перед переходом к следующему шагу

---

### `/app/dashboard` — Дашборд клиента

**Файл:** `src/app/app/dashboard/page.tsx`

**Изменения в v3.1:**

#### 1. Проверка наличия целей
- При загрузке проверяется наличие записей в `nutrition_targets`
- Если целей нет → автоматический редирект на `/onboarding`

#### 2. Навигация по датам (NEW)
- **Header:** Заменена статичная дата на компонент навигации:
  - Кнопка "←" (предыдущий день)
  - Кнопка с датой (клик открывает date picker)
  - Кнопка "→" (следующий день, отключена для будущих дат)
- **Отображение:** "Сегодня, 17 Дек" или "Пн, 16 Дек" для прошлых дат
- **Функциональность:**
  - При смене даты загружаются данные (`daily_logs`) за выбранную дату
  - Все секции обновляются для выбранной даты
  - Кнопки редактирования передают параметр `date` в URL

#### 3. Сводка за выбранную дату
- Заголовок меняется: "Сегодня" или дата (например, "16 декабря")
- Все данные (КБЖУ, вес, приемы пищи) отображаются для выбранной даты
- Кнопка "Редактировать" → `/app/nutrition?date={selectedDate}`

#### 4. Модальное окно добавления приема пищи (AddMealModal) — улучшено

**Новые функции:**
- **Табы:**
  - "Новый" — форма для ввода нового приема пищи
  - "Недавние (N)" — список последних 10 уникальных приемов пищи за последние 7 дней
  - "Вчера (N)" — список всех приемов пищи за вчерашний день (если есть)
- **Копирование:**
  - Клик по приему из "Недавние" или "Вчера" заполняет форму на вкладке "Новый"
  - Можно скорректировать данные перед сохранением
- **Загрузка данных:**
  - Недавние приемы собираются из логов за последние 7 дней
  - Вчерашние приемы загружаются из `daily_logs` за вчерашний день

**Остальная функциональность:**
- Сохранение веса (кликабельный блок)
- Добавление приемов пищи
- Просмотр и редактирование приемов пищи
- Статистика за неделю
- Активные программы питания

**Переходы:**
- → `/app/settings` (кнопка "Настройки")
- → `/app/nutrition?date={selectedDate}` (ввод/редактирование питания)
- → `/app/nutrition?edit={mealId}&date={selectedDate}` (редактирование конкретного приема)
- → `/app/reports` (отчеты — только Premium)
- → `/onboarding` (автоматический редирект, если нет целей)

**Особенности:**
- Дата по умолчанию — сегодня
- Навигация ограничена: нельзя выбрать будущую дату
- Все переходы на страницу питания включают параметр `date`

---

### `/app/nutrition` — Ввод данных о питании

**Файл:** `src/app/app/nutrition/page.tsx`

**Изменения в v3.1:**

#### 1. Поддержка параметра `date` из URL
- Параметр `date` определяет, за какую дату вводятся данные
- Если параметр не указан, используется сегодняшняя дата
- При смене даты загружаются соответствующие данные

#### 2. Поддержка параметра `edit` из URL
- Параметр `edit={mealId}` позволяет редактировать конкретный прием пищи
- При загрузке находится meal по `id` и устанавливается в форму
- Остальные приемы пищи за день не загружаются (только редактируемый)

#### 3. Сохранение за выбранную дату
- Все данные сохраняются в `daily_logs` за дату из параметра `date`
- При сохранении выполняется merge с существующими meals за эту дату
- После сохранения редирект на `/app/dashboard?date={selectedDate}`

**Остальная функциональность:**
- Динамическое переключение типа дня (без блокировки)
- Ввод веса тела
- Множественные приемы пищи
- Уровень голода (5 emoji-кнопок)
- Итоговая сводка "Всего за день" с прогресс-барами

**Переходы:**
- → `/app/dashboard?date={selectedDate}` (после сохранения или нажатия "Назад")
- → `/login` (если пользователь не авторизован)

**Особенности:**
- Дата приема пищи (`mealDate`) может отличаться от выбранной даты (для поправок)
- При редактировании одного приема остальные сохраняются без изменений

---

### `/app/reports` — Отчеты и аналитика (только Premium)

**Файл:** `src/app/app/reports/page.tsx`

**Функциональность:**
- *Без изменений в v3.1*
- Группировка логов по неделям
- Отображение КБЖУ, веса, заметок

**Переходы:**
- → `/app/dashboard` (кнопка "← Назад")
- → `/login` (после выхода)

---

### `/app/settings` — Настройки профиля

**Файл:** `src/app/app/settings/page.tsx`

**Функциональность:**
- *Без изменений в v3.1*
- Редактирование профиля (имя, телефон)
- Смена пароля
- Просмотр статуса подписки
- Информация о тренере (для Premium)
- Выход из системы

**Переходы:**
- → `/app/dashboard` (кнопка "Назад")
- → `/login` (после выхода)

---

## Защищенные страницы для тренеров

### `/app/coach` — Кабинет тренера

**Файл:** `src/app/app/coach/page.tsx`

**Функциональность:**
- *Без изменений в v3.1*
- Список клиентов с приоритетной сортировкой (Traffic Light System)
- Фильтрация и сортировка
- Просмотр статуса выполнения планов

**Переходы:**
- → `/app/coach/[clientId]` (клик по клиенту)
- → `/login` (кнопка выхода)

---

### `/app/coach/[clientId]` — Просмотр дашборда клиента

**Файл:** `src/app/app/coach/[clientId]/page.tsx`

**Функциональность:**
- *Без изменений в v3.1*
- Read-only просмотр дашборда клиента
- Редактирование целей по питанию

**Переходы:**
- → `/app/coach` (кнопка "Назад")

---

## Защищенные страницы для супер-администраторов

### `/admin` — Панель супер-администратора

**Файл:** `src/app/admin/page.tsx`

**Функциональность:**
- *Без изменений в v3.1*
- Управление пользователями
- Редактирование ролей, подписок, назначение тренеров

**Переходы:**
- → `/login` (кнопка выхода)

---

## Система навигации и защиты маршрутов

### Middleware (`src/middleware.ts`)

**Изменения в v3.1:**

#### Новые правила:
- **`/onboarding`:** Доступен только авторизованным пользователям
  - Если неавторизованный пользователь пытается зайти → редирект на `/login`
  - Если авторизованный пользователь с целями пытается зайти → редирект на `/app/dashboard` (обрабатывается на странице)

#### Остальные правила (без изменений):
- Публичные маршруты: `/`, `/login`, `/register`
- Защита `/app/reports` (только Premium)
- Защита `/app/coach` (только тренеры)
- Защита `/admin` (только super_admin)

---

## Особенности реализации v3.1

### Onboarding Flow

1. **Автоматический запуск:**
   - После регистрации пользователь попадает на `/app/dashboard`
   - Дашборд проверяет наличие целей
   - Если целей нет → редирект на `/onboarding`

2. **Расчет целей:**
   - Используется формула Харриса-Бенедикта для BMR
   - TDEE = BMR × коэффициент активности
   - Целевые калории = TDEE × (0.85 для похудения, 1.0 для поддержания, 1.10 для набора)
   - Макронутриенты: 30% белки, 25% жиры, 45% углеводы

3. **Создание записей:**
   - Две записи в `nutrition_targets` (rest и training)
   - Начальный вес в `daily_logs`
   - Биометрические данные в `profiles`

### Date Navigation

1. **Компонент навигации:**
   - Стрелки для переключения дней
   - Кликабельная дата (открывает date picker)
   - Ограничение: нельзя выбрать будущую дату

2. **Загрузка данных:**
   - При смене даты выполняется запрос к `daily_logs` за выбранную дату
   - Обновляются все секции дашборда
   - URL параметры передаются в навигацию

3. **Синхронизация:**
   - Все переходы на `/app/nutrition` включают параметр `date`
   - После сохранения редирект на дашборд с параметром `date`

### Smart Defaults & Copy

1. **Недавние приемы пищи:**
   - Загружаются из логов за последние 7 дней
   - Уникализация по названию (lowercase)
   - Ограничение: максимум 10 приемов

2. **Копирование из вчера:**
   - Загружаются все приемы пищи за вчерашний день
   - Клик по приему заполняет форму
   - Можно скорректировать перед сохранением

3. **Табы в модальном окне:**
   - "Новый" — форма для ввода
   - "Недавние" — список недавних приемов
   - "Вчера" — список вчерашних приемов (показывается только если есть данные)

---

## Технические детали

### Используемые технологии

- **Frontend:** Next.js 16 (App Router), React 19, Tailwind CSS v4
- **Backend:** Supabase (Authentication, Database, RLS)
- **State Management:** React Hooks (useState, useEffect, useMemo)
- **Routing:** Next.js App Router с middleware для защиты маршрутов
- **Icons:** Lucide React

### База данных

#### Новые поля в таблице `profiles` (v3.1):
- `gender`: TEXT (CHECK: 'male', 'female', 'other')
- `birth_date`: DATE
- `height`: INTEGER (рост в см)
- `activity_level`: TEXT (CHECK: 'sedentary', 'light', 'moderate', 'active', 'very_active')

#### Новые поля в таблице `daily_logs` (v3.1):
- `is_completed`: BOOLEAN (DEFAULT false) — флаг завершения дня (Check-in)

#### Миграция:
- Файл: `docs/migrations/v3.1_add_onboarding_fields.sql`
- Добавляет новые поля и индексы

### Безопасность

- **Row Level Security (RLS)** в Supabase
- **Middleware** для проверки авторизации и ролей
- **Onboarding защита:** Только авторизованные пользователи могут зайти на `/onboarding`
- **Проверка целей:** Дашборд автоматически редиректит на onboarding, если целей нет

### Адаптивность

- **Mobile First подход:** Все новые компоненты адаптивны
- Навигация по датам работает на мобильных устройствах
- Модальное окно AddMealModal с табами адаптивно

---

## Компоненты

### `DayToggle` (`src/components/DayToggle.tsx`)
- *Без изменений в v3.1*

### `Paywall` (`src/components/Paywall.tsx`)
- *Без изменений в v3.1*

### `ClientDashboardView` (`src/components/ClientDashboardView.tsx`)
- *Без изменений в v3.1*

### `AddMealModal` (встроенный компонент в `src/app/app/dashboard/page.tsx`)
- **Новый в v3.1**
- Табы: Новый / Недавние / Вчера
- Загрузка недавних и вчерашних приемов пищи
- Копирование данных в форму

---

## Примечания

1. **Onboarding обязателен:** Новые пользователи не могут использовать приложение без прохождения onboarding (нет целей для сравнения)

2. **Навигация по датам:** Позволяет заполнять дневник за прошлые дни, что критично для retention

3. **Копирование приемов пищи:** Ускоряет ввод данных для пользователей с повторяющимся рационом

4. **Расчет целей:** Free пользователи получают цели на основе формул, Premium — от тренера (может перезаписать)

5. **Миграция БД:** Необходимо выполнить `docs/migrations/v3.1_add_onboarding_fields.sql` перед использованием новых функций

---

*Документ обновлен: 17 декабря 2025 (на основе текущей реализации в коде v3.1)*


