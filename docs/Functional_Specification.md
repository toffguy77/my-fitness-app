# Функциональная спецификация My Fitness App

**Версия документа:** 1.0  
**Дата создания:** Январь 2025  
**Статус:** Актуальная реализация v4.0+

---

## Обзор

Этот документ описывает детальную функциональную спецификацию всех функций My Fitness App, включая пользовательские сценарии, workflows, бизнес-правила и интеграции.

---

## Функции для клиентов (Client)

### 1. Авторизация и регистрация

#### 1.1 Регистрация

**Описание:** Создание нового аккаунта клиента

**Маршрут:** `/register`

**Функциональность:**
- Форма регистрации с полями:
  - Email (обязательно, валидация формата)
  - Password (обязательно, минимум 8 символов)
  - Confirm Password (обязательно, должно совпадать)
- Опционально: инвайт-код тренера (`?code=XXXXX`)
- Автоматическое создание профиля с `role = 'client'`
- Дефолтные значения: `subscription_status = 'free'`, `subscription_tier = 'basic'`
- Автоматическое назначение тренера при использовании инвайт-кода
- Редирект на `/onboarding` или `/app/dashboard` после регистрации

**Валидация:**
- Email должен быть валидным
- Password минимум 8 символов
- Passwords должны совпадать
- Email не должен быть уже зарегистрирован

**User Story:**
```
Как новый пользователь
Я хочу зарегистрироваться в системе
Чтобы начать отслеживать свое питание
```

#### 1.2 Авторизация

**Описание:** Вход в систему существующего пользователя

**Маршрут:** `/login`

**Функциональность:**
- Форма авторизации с полями:
  - Email
  - Password
- Кнопка "Войти"
- Ссылка на регистрацию
- Обработка ошибок авторизации
- Редирект на соответствующий маршрут после авторизации:
  - Client → `/app/dashboard` (или `/onboarding` если нет целей)
  - Coach → `/app/coach`
  - Super Admin → `/admin`

**Валидация:**
- Email и password обязательны
- Проверка существования пользователя
- Проверка правильности пароля

**User Story:**
```
Как зарегистрированный пользователь
Я хочу войти в систему
Чтобы получить доступ к своему дневнику питания
```

#### 1.3 Выход из системы

**Описание:** Завершение сессии пользователя

**Функциональность:**
- Кнопка "Выход" в настройках
- Очистка сессии
- Редирект на `/login`

---

### 2. Онбординг

**Описание:** Мастер настройки для новых пользователей

**Маршрут:** `/onboarding`

**Функциональность:**
- 3 шага онбординга:
  1. **Биометрия:**
     - Пол (male, female, other)
     - Дата рождения
     - Рост (см)
  2. **Активность:**
     - Уровень активности (sedentary, light, moderate, active, very_active)
  3. **Цель:**
     - Цель (weight_loss, weight_maintain, weight_gain)
- Автоматический расчет BMR/TDEE на основе биометрии
- Автоматическое создание целей питания (nutrition_targets)
- Сохранение данных в профиль
- Редирект на `/app/dashboard` после завершения

**Расчеты:**
- **BMR (Basal Metabolic Rate):** Формула Миффлина-Сан Жеора
- **TDEE (Total Daily Energy Expenditure):** BMR × коэффициент активности
- **Цели КБЖУ:** На основе TDEE и цели (дефицит/профицит)

**User Story:**
```
Как новый пользователь
Я хочу пройти онбординг
Чтобы система автоматически рассчитала мои цели питания
```

---

### 3. Дашборд клиента

**Описание:** Главная страница клиента с обзором прогресса

**Маршрут:** `/app/dashboard`

**Функциональность:**

#### 3.1 Навигация по датам
- Date Picker для выбора даты
- Кнопки "Вчера", "Сегодня", "Завтра"
- Отображение выбранной даты

#### 3.2 Сводка КБЖУ за день
- Отображение фактических значений:
  - Калории (ккал)
  - Белки (г)
  - Жиры (г)
  - Углеводы (г)
- Для Premium: ProgressBar с визуализацией прогресса
- Цветовая индикация:
  - Зеленый (≥80% от цели)
  - Желтый (≥50% от цели)
  - Красный (<50% от цели)

#### 3.3 Виджет заметки тренера (Premium)
- Отображение заметки от тренера за выбранную дату
- Заглушка для истекших подписок
- Кнопка "Продлить подписку" для истекших подписок

#### 3.4 Кнопка "Завершить день" (Check-in)
- Валидация перед завершением:
  - Вес должен быть введен
  - Хотя бы один прием пищи должен быть добавлен
- Блокировка редактирования после завершения
- Уведомление тренера (для Premium)
- Toast уведомление об успехе

#### 3.5 Просмотр и управление приемами пищи
- Список приемов пищи за день
- Добавление нового приема пищи (модальное окно)
- Редактирование приема пищи
- Удаление приема пищи
- Блокировка редактирования для завершенных дней

#### 3.6 Статистика за неделю
- Средние значения КБЖУ за последние 7 дней
- Количество дней с данными
- Процент выполнения целей

#### 3.7 Глобальный баннер подписки
- Отображение для истекших подписок
- Предупреждение о необходимости продления
- Кнопка "Продлить" → `/app/settings?tab=subscription`

**User Story:**
```
Как клиент
Я хочу видеть свой дашборд
Чтобы быстро понять свой прогресс за день
```

---

### 4. Ввод данных о питании

**Описание:** Страница для ввода и редактирования данных о питании

**Маршрут:** `/app/nutrition`

**Функциональность:**

#### 4.1 Навигация по датам
- Параметр `?date=YYYY-MM-DD` в URL
- Date Picker для выбора даты
- Блокировка редактирования для завершенных дней

#### 4.2 Переключатель типа дня
- Тренировка / Отдых
- Динамическое переключение целей питания
- Сохранение в `target_type`

#### 4.3 Ввод веса тела
- Поле для ввода веса (кг)
- Валидация: вес > 0 и < 500 кг

#### 4.4 Множественные приемы пищи
- Список приемов пищи
- Каждый прием пищи содержит:
  - Название (автоматическое по времени или ручное)
  - Вес (г)
  - Калории (ккал)
  - Белки (г)
  - Жиры (г)
  - Углеводы (г)
  - Фото (UI готов, обработка через OCR)
- Добавление нового приема пищи
- Удаление приема пищи
- Редактирование приема пищи

#### 4.5 Валидация приемов пищи
- Проверка веса (> 0, предупреждение если > 10 кг)
- Проверка калорий (предупреждение если > 5000 ккал)
- Проверка соответствия калорий макронутриентам (разница ≤ 50 ккал)
- Визуальные предупреждения через ValidationWarning

#### 4.6 Дневные totals
- Автоматический расчет суммарных КБЖУ
- Валидация дневных totals:
  - Проверка соответствия калорий макронутриентам
  - Проверка лимитов (калории ≤ 10000, белки ≤ 1000г, жиры ≤ 500г, углеводы ≤ 1500г)

#### 4.7 Дополнительные данные
- Уровень голода (1-10) с описаниями
- Уровень энергии (1-10) с описаниями
- Комментарий к дню

#### 4.8 ProgressBar для макронутриентов
- Визуализация прогресса по белкам, жирам, углеводам
- Цветовая индикация на основе процента выполнения цели
- Отображается только если установлены цели питания

#### 4.9 Сохранение данных
- Оптимистичные обновления UI
- Toast уведомления об успехе/ошибке
- Редирект на `/app/dashboard` после сохранения

**User Story:**
```
Как клиент
Я хочу вводить данные о питании
Чтобы отслеживать свой рацион
```

---

### 5. Отчеты и аналитика (Premium)

**Описание:** Страница с отчетами, графиками и статистикой

**Маршрут:** `/app/reports`

**Функциональность:**

#### 5.1 Вкладки
- **Графики:** WeightChart и MacrosChart
- **Таблица:** Таблица данных с фильтрами и пагинацией
- **Статистика:** Расчетные метрики

#### 5.2 Графики
- **WeightChart:**
  - Линейный график динамики веса
  - Трендовая линия (линейная регрессия)
  - Фильтр по периоду: 7 дней, 30 дней, 3 месяца, Все время
- **MacrosChart:**
  - График калорий с целевой линией
  - График макронутриентов (белки, жиры, углеводы) с целевыми линиями
  - Фильтр по периоду: 7 дней, 30 дней, 3 месяца, Все время

#### 5.3 Таблица данных
- Отображение всех дневных логов
- Фильтры:
  - По диапазону дат
  - По типу дня (все/тренировка/отдых)
  - Сортировка по дате, калориям, весу (возрастание/убывание)
- Пагинация (20 элементов на страницу)

#### 5.4 Статистика
- Общая статистика:
  - Дней с данными
  - Средние калории/белки/жиры/углеводы
- Динамика веса:
  - Изменение веса
  - Начальный вес
  - Текущий вес
  - Диапазон
- Суммарные значения:
  - Всего калорий/белков/жиров/углеводов

#### 5.5 Экспорт данных
- Форматы: CSV, JSON, PDF
- Экспорт отфильтрованных данных
- Включает цели питания для PDF экспорта
- Автоматическое именование файлов с датой

**User Story:**
```
Как Premium клиент
Я хочу видеть отчеты и графики
Чтобы анализировать свой прогресс
```

---

### 6. Настройки профиля

**Описание:** Страница настроек профиля и подписки

**Маршрут:** `/app/settings`

**Функциональность:**

#### 6.1 Редактирование профиля
- Имя (full_name)
- Телефон (phone)
- Аватар (avatar_url) — для будущего использования
- Сохранение изменений

#### 6.2 Смена пароля
- Текущий пароль
- Новый пароль
- Подтверждение нового пароля
- Валидация и сохранение

#### 6.3 Статус подписки
- Отображение текущего статуса (free, active, cancelled, past_due, expired)
- Уровень подписки (basic, premium)
- Даты начала и окончания подписки
- Кнопка "Продлить подписку" для истекших подписок

#### 6.4 Информация о тренере (Premium)
- Имя тренера
- Email тренера
- Ссылка на чат с тренером

#### 6.5 Пересчет целей питания
- Кнопка "Пересчитать цели"
- Проверка наличия биометрических данных
- Проверка наличия веса в дневнике
- Автоматический пересчет BMR/TDEE и целей
- Toast уведомление об успехе/ошибке

#### 6.6 Настройки уведомлений
- Email ежедневная сводка (email_daily_digest)
- Email мгновенные уведомления (email_realtime_alerts)
- Сохранение настроек

#### 6.7 Выход из системы
- Кнопка "Выход"
- Подтверждение выхода
- Очистка сессии
- Редирект на `/login`

**User Story:**
```
Как клиент
Я хочу управлять настройками профиля
Чтобы обновить свою информацию и предпочтения
```

---

### 7. Чат с тренером (Premium)

**Описание:** Real-time чат между клиентом и тренером

**Функциональность:**

#### 7.1 ChatWidget
- Компактный виджет чата
- Индикатор непрочитанных сообщений
- Открытие ChatWindow при клике

#### 7.2 ChatWindow
- Полноэкранное окно чата
- Список сообщений (MessageList)
- Поле ввода (MessageInput)
- Индикатор "печатает..."
- Real-time обновления через WebSocket

#### 7.3 Сообщения
- Отображение отправленных и полученных сообщений
- Временные метки
- Индикатор прочтения
- Автопрокрутка к новым сообщениям

**User Story:**
```
Как Premium клиент
Я хочу общаться с тренером в реальном времени
Чтобы получать быструю обратную связь
```

---

### 8. OCR распознавание (Premium)

**Описание:** Распознавание этикеток продуктов через OCR

**Функциональность:**

#### 8.1 Загрузка фото
- Кнопка "Сканировать этикетку"
- Выбор файла или фото с камеры
- Валидация формата (jpg, png, webp)

#### 8.2 OCR обработка
- Гибридный подход:
  - Tesseract.js (клиентская обработка)
  - OpenRouter API (облачная обработка)
- Извлечение данных:
  - Название продукта
  - КБЖУ на 100г
- Уверенность распознавания (confidence)

#### 8.3 Подтверждение данных
- Отображение распознанных данных
- Возможность редактирования
- Сохранение в форму питания
- Сохранение в базу продуктов (опционально)

**User Story:**
```
Как Premium клиент
Я хочу сканировать этикетки продуктов
Чтобы быстро вводить данные о питании
```

---

### 9. База продуктов (Premium)

**Описание:** Поиск и использование продуктов из базы

**Функциональность:**

#### 9.1 Поиск продуктов
- Поле поиска по названию
- Автозаполнение при вводе
- Поиск в глобальной базе (products) и пользовательских продуктах (user_products)
- Отображение КБЖУ на 100г

#### 9.2 Использование продукта
- Выбор продукта из результатов поиска
- Автоматическое заполнение формы питания
- Расчет КБЖУ на основе веса порции
- Сохранение в историю использования

#### 9.3 Пользовательские продукты
- Добавление собственного продукта
- Редактирование пользовательского продукта
- Удаление пользовательского продукта
- История часто используемых продуктов

**User Story:**
```
Как Premium клиент
Я хочу использовать базу продуктов
Чтобы быстро вводить данные о питании
```

---

### 10. Система достижений

**Описание:** Достижения и бейджи для мотивации

**Маршрут:** `/app/achievements`

**Функциональность:**

#### 10.1 Список достижений
- Категории: nutrition, weight, activity, accuracy
- Прогресс выполнения (0-100%)
- Полученные достижения
- Неполученные достижения

#### 10.2 Уведомления о достижениях
- Автоматическое уведомление при получении
- Отображение бейджа
- Публикация в социальных сетях (Web Share API)

**User Story:**
```
Как клиент
Я хочу получать достижения
Чтобы мотивировать себя к регулярному использованию
```

---

## Функции для тренеров (Coach)

### 1. Кабинет тренера

**Описание:** Главная страница тренера со списком клиентов

**Маршрут:** `/app/coach`

**Функциональность:**

#### 1.1 Список клиентов
- Отображение всех Premium клиентов тренера
- Traffic Light System v2 для приоритизации:
  - **Red:** Нет данных за последние 3+ дня
  - **Yellow:** Нет данных за последние 1-2 дня
  - **Green:** Есть данные за сегодня или вчера
  - **Grey:** День завершен (is_completed = true)

#### 1.2 Фильтры
- По статусу: All / Red / Yellow / Green / Grey
- Поиск по имени клиента

#### 1.3 Сортировка
- По статусу (приоритет)
- По имени (алфавит)
- По дате последнего чекина

#### 1.4 Переход к клиенту
- Клик по клиенту → `/app/coach/[clientId]`

**User Story:**
```
Как тренер
Я хочу видеть список своих клиентов
Чтобы приоритизировать работу с ними
```

---

### 2. Просмотр дашборда клиента

**Описание:** Просмотр данных клиента тренером

**Маршрут:** `/app/coach/[clientId]`

**Функциональность:**

#### 2.1 Read-only дашборд
- Просмотр всех данных клиента
- Навигация по датам
- Просмотр приемов пищи
- Просмотр веса и КБЖУ

#### 2.2 Редактирование целей питания
- Редактирование целей для тренировочных дней
- Редактирование целей для дней отдыха
- Валидация на сервере (CHECK constraints)
- Визуальная валидация в UI
- Toast уведомления об успехе/ошибке

#### 2.3 Заметки тренера
- Date Picker для выбора даты
- Текстовое поле для ввода заметки
- Сохранение заметки в `coach_notes`
- Оптимистичные обновления UI
- Умная отправка уведомлений:
  - Проверка настроек клиента (email_realtime_alerts)
  - Мгновенная отправка или добавление в очередь дайджеста

#### 2.4 Чат с клиентом
- ChatWindow для общения
- Real-time обновления
- История сообщений

**User Story:**
```
Как тренер
Я хочу просматривать данные клиента
Чтобы давать обратную связь и корректировать цели
```

---

### 3. Инвайт-коды

**Описание:** Генерация и управление инвайт-кодами

**Маршрут:** `/app/coach/invites`

**Функциональность:**

#### 3.1 Генерация кодов
- Кнопка "Создать новый код"
- Автоматическая генерация 8-символьного кода
- Настройки:
  - Максимальное количество использований (опционально)
  - Срок действия (опционально)

#### 3.2 Список кодов
- Отображение всех созданных кодов
- Статус (активен/неактивен)
- Количество использований
- Дата последнего использования

#### 3.3 Управление кодами
- Деактивация кода
- Удаление кода
- Копирование кода в буфер обмена

**User Story:**
```
Как тренер
Я хочу создавать инвайт-коды
Чтобы привлекать новых клиентов
```

---

## Функции для супер-администраторов (Super Admin)

### 1. Панель администратора

**Описание:** Управление всей платформой

**Маршрут:** `/admin`

**Функциональность:**

#### 1.1 Управление пользователями
- Таблица всех пользователей
- Поиск по email/имени
- Фильтры: роль, статус подписки

#### 1.2 Редактирование профилей
- Изменение роли (client ↔ coach)
- Управление подпиской:
  - Статус (free, active, cancelled, past_due, expired)
  - Уровень (basic, premium)
  - Даты начала/окончания
- Назначение тренера клиенту (coach_id)
- Сохранение изменений

#### 1.3 CRUD операции
- Создание пользователей (вручную)
- Редактирование всех полей
- Удаление пользователей (с подтверждением)

**User Story:**
```
Как супер-администратор
Я хочу управлять пользователями и подписками
Чтобы контролировать работу платформы
```

---

## Интеграции

### 1. Supabase

**Описание:** Backend-as-a-Service для БД, Auth, Realtime

**Использование:**
- PostgreSQL база данных
- Supabase Auth для авторизации
- Supabase Realtime для WebSocket (чат)
- Supabase Edge Functions для serverless функций
- Row Level Security для безопасности

### 2. Resend API

**Описание:** Отправка email уведомлений

**Использование:**
- Уведомления о заметках тренера
- Уведомления о истекающих подписках
- Уведомления об истекших подписках
- Напоминания о вводе данных

**Шаблоны:**
- `coach_note_notification`
- `subscription_expiring`
- `subscription_expired`
- `reminder_data_entry`

### 3. Open Food Facts API

**Описание:** База продуктов для автозаполнения

**Использование:**
- Поиск продуктов по названию
- Получение КБЖУ на 100г
- Кэширование популярных продуктов в БД

### 4. OpenRouter API

**Описание:** OCR распознавание через AI модели

**Использование:**
- Распознавание текста с фото этикеток
- Извлечение КБЖУ из изображений
- Гибридный подход с Tesseract.js

---

## Валидация и бизнес-правила

### 1. Валидация данных о питании

#### Клиентская валидация
- Вес порции: > 0, предупреждение если > 10 кг
- Калории: предупреждение если > 5000 ккал
- Соответствие калорий макронутриентам: разница ≤ 50 ккал
- Лимиты дневных totals:
  - Калории ≤ 10000 ккал
  - Белки ≤ 1000 г
  - Жиры ≤ 500 г
  - Углеводы ≤ 1500 г

#### Серверная валидация
- PostgreSQL CHECK constraints для nutrition_targets:
  - Калории: 1000-6000 ккал
  - Белки: 20-500 г
  - Жиры: 20-200 г
  - Углеводы: 20-500 г
- Database functions для валидации daily_logs
- Триггеры для автоматической валидации

### 2. Бизнес-правила подписок

- Free клиенты не могут иметь тренера (защищено триггером)
- Premium клиенты должны иметь активную подписку
- Подписки автоматически деактивируются при истечении
- Уведомления о истекающих подписках (за 3 дня)

### 3. Бизнес-правила завершения дня

- Вес должен быть введен
- Хотя бы один прием пищи должен быть добавлен
- После завершения редактирование блокируется
- Тренер получает уведомление (для Premium)

---

## Связанные документы

- [Product_Requirements.md](./Product_Requirements.md) - Требования к продукту
- [Business_Model.md](./Business_Model.md) - Бизнес-модель
- [Technical_Architecture.md](./Technical_Architecture.md) - Техническая архитектура

---

**Последнее обновление:** Январь 2025  
**Версия документа:** 1.0

