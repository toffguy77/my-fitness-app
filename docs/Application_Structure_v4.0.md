# Структура приложения My Fitness App v4.0

## Обзор

My Fitness App — это Freemium SaaS платформа для управления питанием и отслеживания прогресса. Документация v4.0 отражает **текущую реализацию** в коде (по состоянию на декабрь 2025) с добавлением функций **UX Improvements & Data Visualization**: Toast уведомления, Loading индикаторы, ProgressBar компоненты, Графики (WeightChart, MacrosChart), Экспорт данных, Фильтры и пагинация, Оптимистичные обновления.

---

## Ключевые изменения v4.0

1. **Toast уведомления:** Замена всех `alert()` на `react-hot-toast` для лучшего UX
2. **Loading индикаторы:** Spinner и SkeletonLoader компоненты для визуальной обратной связи
3. **ProgressBar компоненты:** Визуализация прогресса по КБЖУ в dashboard и nutrition
4. **Графики:** WeightChart и MacrosChart для визуализации данных в reports
5. **Экспорт данных:** CSV, JSON, PDF экспорт через ExportButton компонент
6. **Фильтры и пагинация:** ReportFilters и Pagination компоненты для reports и admin
7. **Оптимистичные обновления:** Мгновенное обновление UI при сохранении данных в nutrition и coach notes

---

## Роли пользователей

*Без изменений по сравнению с v3.4: Client (Free/Premium), Coach, Super Admin*

---

## Публичные страницы (не требуют авторизации)

*Без изменений по сравнению с v3.4: `/`, `/login`, `/register`*

---

## Защищенные страницы для клиентов

### `/onboarding` — Мастер настройки

**Файл:** `src/app/onboarding/page.tsx`

**Функциональность:**
- *Без изменений в v4.0*
- 3 шага: Биометрия, Активность, Цель
- Расчет BMR/TDEE и создание целей

**Переходы:**
- → `/app/dashboard` (после завершения)

---

### `/app/dashboard` — Дашборд клиента

**Файл:** `src/app/app/dashboard/page.tsx`

**Изменения в v4.0:**

#### 1. ProgressBar для КБЖУ (NEW)
- **Расположение:** В секции "Сегодня" вместо текстового отображения
- **Компонент:** `src/components/ProgressBar.tsx`
- **Функциональность:**
  - Показывает прогресс по калориям, белкам, жирам, углеводам
  - Цветовая индикация: зеленый (≥80%), желтый (≥50%), красный (<50%)
  - Отображается только для Premium пользователей с установленными целями
  - Формат: "Текущее / Целевое (Процент%)"
  - Если целей нет, показывается простое текстовое отображение

#### 2. Toast уведомления (NEW)
- **Замена:** Все `alert()` заменены на `toast.error()` и `toast.success()`
- **Библиотека:** `react-hot-toast`
- **Примеры использования:**
  - Успешное сохранение веса: `toast.success('Вес сохранен')`
  - Ошибка загрузки данных: `toast.error('Ошибка загрузки данных')`
  - Успешное завершение дня: `toast.success('День завершен!')`

**Остальная функциональность:**
- Навигация по датам
- Сводка КБЖУ за выбранную дату (с ProgressBar для Premium)
- Виджет заметки тренера (Premium)
- Кнопка "Завершить день"
- Просмотр и управление приемами пищи
- Статистика за неделю

**Переходы:**
- → `/app/settings` (кнопка "Настройки")
- → `/app/nutrition?date={selectedDate}` (ввод/редактирование питания)
- → `/app/reports` (отчеты — только Premium)

**Особенности:**
- ProgressBar автоматически обновляется при изменении данных
- Toast уведомления неблокирующие и автоматически исчезают через 3 секунды

---

### `/app/nutrition` — Ввод данных о питании

**Файл:** `src/app/app/nutrition/page.tsx`

**Изменения в v4.0:**

#### 1. ProgressBar для макронутриентов (NEW)
- **Расположение:** В секции "TARGETS SUMMARY" вместо MacroBar компонента
- **Компонент:** `src/components/ProgressBar.tsx`
- **Функциональность:**
  - Показывает прогресс по белкам, жирам, углеводам
  - Цветовая индикация на основе процента выполнения цели
  - Отображается только если установлены цели питания

#### 2. Оптимистичные обновления (NEW)
- **Функциональность:**
  - При сохранении данных сразу обновляется UI (без ожидания ответа сервера)
  - Если сохранение не удалось, изменения откатываются
  - Показывается toast уведомление об успехе/ошибке
- **Реализация:**
  - Сохраняется предыдущее состояние перед сохранением
  - При ошибке состояние восстанавливается
  - Toast уведомления для обратной связи

#### 3. Toast уведомления (NEW)
- **Замена:** Все `alert()` заменены на `toast.error()` и `toast.success()`
- **Примеры:**
  - Успешное сохранение: `toast.success('Данные сохранены')`
  - Ошибка валидации: `toast.error('Ошибка валидации: ...')`

**Остальная функциональность:**
- Поддержка параметра `date` из URL
- Поддержка параметра `edit` для редактирования конкретного приема
- Динамическое переключение типа дня
- Ввод веса тела
- Множественные приемы пищи
- Блокировка редактирования завершенных дней
- Валидация приемов пищи и дневных totals

**Переходы:**
- → `/app/dashboard?date={selectedDate}` (после сохранения или если день завершен)
- → `/login` (если пользователь не авторизован)

**Особенности:**
- Оптимистичные обновления улучшают воспринимаемую производительность
- Toast уведомления неблокирующие

---

### `/app/reports` — Отчеты и аналитика (только Premium)

**Файл:** `src/app/app/reports/page.tsx`

**Изменения в v4.0:**

#### 1. Вкладки (NEW)
- **Структура:** Три вкладки: Графики, Таблица, Статистика
- **Компоненты:**
  - Графики: `WeightChart`, `MacrosChart`
  - Таблица: Таблица данных с фильтрами и пагинацией
  - Статистика: Расчетные метрики (средние значения, изменения веса)

#### 2. Графики (NEW)
- **WeightChart:**
  - Линейный график динамики веса
  - Трендовая линия (линейная регрессия)
  - Фильтр по периоду: 7 дней, 30 дней, 3 месяца, Все время
  - Отображается только если есть данные о весе
- **MacrosChart:**
  - График калорий (линейный с целевой линией)
  - График макронутриентов (белки, жиры, углеводы) с целевыми линиями
  - Фильтр по периоду: 7 дней, 30 дней, 3 месяца, Все время
  - Целевые линии отображаются если установлены цели питания

#### 3. Таблица данных (NEW)
- **Компоненты:**
  - `ReportFilters`: Фильтры по дате, типу дня, сортировка
  - `Pagination`: Пагинация для больших списков (20 элементов на страницу)
- **Функциональность:**
  - Фильтрация по диапазону дат
  - Фильтрация по типу дня (все/тренировка/отдых)
  - Сортировка по дате, калориям, весу (возрастание/убывание)
  - Пагинация с информацией о текущей странице и общем количестве элементов

#### 4. Статистика (NEW)
- **Метрики:**
  - Общая статистика: Дней с данными, Средние калории/белки/жиры/углеводы
  - Динамика веса: Изменение веса, Начальный вес, Текущий вес, Диапазон
  - Суммарные значения: Всего калорий/белков/жиров/углеводов
- **Расчет:**
  - Средние значения рассчитываются только для дней с данными (> 0 калорий)
  - Изменение веса рассчитывается как разница между первым и последним весом
  - Все значения округляются до целых чисел

#### 5. Экспорт данных (NEW)
- **Компонент:** `ExportButton`
- **Форматы:** CSV, JSON, PDF
- **Функциональность:**
  - Экспорт отфильтрованных данных
  - Включает цели питания для PDF экспорта
  - Toast уведомления об успехе/ошибке экспорта

**Переходы:**
- → `/app/dashboard` (кнопка "← Назад")

**Особенности:**
- Все вкладки используют одни и те же данные (filteredLogs)
- Фильтры применяются ко всем вкладкам
- Графики автоматически обновляются при изменении фильтров

---

### `/app/settings` — Настройки профиля

**Файл:** `src/app/app/settings/page.tsx`

**Изменения в v4.0:**

#### 1. Toast уведомления (NEW)
- **Замена:** Все `alert()` заменены на `toast.error()` и `toast.success()`
- **Примеры:**
  - Успешное сохранение профиля: `toast.success('Профиль обновлен')`
  - Ошибка пересчета целей: `toast.error('Ошибка пересчета целей')`

**Остальная функциональность:**
- Редактирование профиля (имя, телефон)
- Смена пароля
- Просмотр статуса подписки
- Информация о тренере (для Premium)
- Пересчет целей питания
- Настройки уведомлений
- Выход из системы

**Переходы:**
- → `/app/dashboard` (кнопка "Назад")
- → `/onboarding` (если нет биометрических данных при пересчете)
- → `/login` (после выхода)

---

## Защищенные страницы для тренеров

### `/app/coach` — Кабинет тренера

**Файл:** `src/app/app/coach/page.tsx`

**Функциональность:**
- *Без изменений в v4.0*
- Список клиентов с Traffic Light System v2
- Фильтры по статусу (All / Red / Yellow / Green / Grey)
- Сортировка по статусу, имени, дате последнего чекина
- Переход к просмотру дашборда клиента

**Переходы:**
- → `/app/coach/[clientId]` (клик по клиенту)
- → `/login` (кнопка выхода)

---

### `/app/coach/[clientId]` — Просмотр дашборда клиента

**Файл:** `src/app/app/coach/[clientId]/page.tsx`

**Изменения в v4.0:**

#### 1. Оптимистичные обновления (NEW)
- **Функциональность:**
  - При сохранении заметки сразу обновляется UI (показывается сохраненная заметка)
  - Если сохранение не удалось, изменения откатываются
  - Показывается toast уведомление об успехе/ошибке
- **Реализация:**
  - Сохраняется предыдущее состояние заметки перед сохранением
  - При ошибке состояние восстанавливается
  - Toast уведомления для обратной связи

#### 2. Toast уведомления (NEW)
- **Замена:** Все `alert()` заменены на `toast.error()` и `toast.success()`
- **Примеры:**
  - Успешное сохранение заметки: `toast.success('Заметка сохранена')`
  - Ошибка сохранения: `toast.error('Ошибка сохранения заметки')`

**Остальная функциональность:**
- Date Picker для заметок
- Текстовое поле для ввода заметки
- Сохранение заметки в `coach_notes`
- Read-only просмотр дашборда клиента
- Редактирование целей по питанию (с валидацией)
- Умная отправка уведомлений (проверка настроек клиента)

**Переходы:**
- → `/app/coach` (кнопка "Назад")

**Особенности:**
- Оптимистичные обновления улучшают воспринимаемую производительность
- Toast уведомления неблокирующие

---

## Защищенные страницы для супер-администраторов

### `/admin` — Панель супер-администратора

**Файл:** `src/app/admin/page.tsx`

**Изменения в v4.0:**

#### 1. Toast уведомления (NEW)
- **Замена:** Все `alert()` заменены на `toast.error()` и `toast.success()`
- **Примеры:**
  - Успешное обновление пользователя: `toast.success('Пользователь обновлен')`
  - Ошибка сохранения: `toast.error('Ошибка сохранения')`

**Остальная функциональность:**
- Управление пользователями
- Редактирование ролей, подписок, назначение тренеров

**Переходы:**
- → `/login` (кнопка выхода)

---

## Система навигации и защиты маршрутов

### Middleware (`src/middleware.ts`)

**Функциональность:**
- *Без изменений в v4.0*
- Защита `/onboarding` (только авторизованные)
- Защита `/app/reports` (только Premium)
- Защита `/app/coach` (только тренеры)
- Защита `/admin` (только super_admin)

---

## Особенности реализации v4.0

### Toast Provider

1. **Глобальная интеграция:**
   - `ToastProvider` обернут вокруг всего приложения в `src/app/layout.tsx`
   - Использует `react-hot-toast` библиотеку
   - Настройки: позиция top-right, длительность 3 секунды, темная тема

2. **Использование:**
   - `toast.success(message)` для успешных операций
   - `toast.error(message)` для ошибок
   - Автоматическое исчезновение через 3 секунды
   - Неблокирующие уведомления

### Loading индикаторы

1. **LoadingSpinner:**
   - Компонент для отображения спиннера загрузки
   - Варианты размера: sm, default, lg, xl
   - Варианты цвета: default, primary, secondary, white
   - Используется в reports page при загрузке данных

2. **SkeletonLoader:**
   - Компонент для skeleton loading состояний
   - Анимация pulse для плавного эффекта
   - Настраиваемое количество элементов и стили

### ProgressBar компонент

1. **Функциональность:**
   - Визуализация прогресса по текущему значению и цели
   - Цветовая индикация на основе процента выполнения
   - Отображение текущего значения, цели и процента
   - Поддержка единиц измерения (ккал, г)

2. **Использование:**
   - Dashboard: Прогресс по КБЖУ за день
   - Nutrition: Прогресс по макронутриентам

### Графики

1. **WeightChart:**
   - Линейный график динамики веса
   - Трендовая линия (линейная регрессия)
   - Фильтр по периоду
   - Использует библиотеку `recharts`

2. **MacrosChart:**
   - График калорий с целевой линией
   - График макронутриентов (белки, жиры, углеводы) с целевыми линиями
   - Фильтр по периоду
   - Использует библиотеку `recharts`

### Экспорт данных

1. **Форматы:**
   - CSV: через библиотеку `papaparse`
   - JSON: стандартный JSON.stringify
   - PDF: через библиотеку `jspdf` и `jspdf-autotable`

2. **Функциональность:**
   - Экспорт отфильтрованных данных
   - Включает цели питания для PDF экспорта
   - Автоматическое именование файлов с датой

### Фильтры и пагинация

1. **ReportFilters:**
   - Фильтрация по диапазону дат
   - Фильтрация по типу дня
   - Сортировка по дате, калориям, весу
   - Сброс фильтров

2. **Pagination:**
   - Пагинация для больших списков
   - Настраиваемое количество элементов на страницу (по умолчанию 20)
   - Отображение информации о текущей странице и общем количестве элементов
   - Навигация по страницам с многоточием для больших списков

### Оптимистичные обновления

1. **Nutrition Page:**
   - Сохранение предыдущего состояния перед сохранением
   - Мгновенное обновление UI
   - Откат изменений при ошибке
   - Toast уведомления для обратной связи

2. **Coach Notes:**
   - Сохранение предыдущего состояния заметки перед сохранением
   - Мгновенное отображение сохраненной заметки
   - Откат изменений при ошибке
   - Toast уведомления для обратной связи

---

## Технические детали

### Используемые технологии

- **Frontend:** Next.js 16 (App Router), React 19, Tailwind CSS v4
- **Backend:** Supabase (Authentication, Database, RLS)
- **Validation:** Zod для server-side валидации
- **State Management:** React Hooks (useState, useEffect, useMemo)
- **Routing:** Next.js App Router с middleware для защиты маршрутов
- **Icons:** Lucide React
- **Toast:** react-hot-toast
- **Charts:** recharts
- **Export:** papaparse (CSV), jspdf (PDF)

### База данных

*Без изменений по сравнению с v3.4*

### Безопасность

*Без изменений по сравнению с v3.4*

### Адаптивность

- **Mobile First подход:** Все новые компоненты адаптивны
- ProgressBar адаптивен
- WeightChart и MacrosChart адаптивны (ResponsiveContainer)
- ReportFilters адаптивен
- Pagination адаптивен

---

## Компоненты

### `ToastProvider` (`src/components/ToastProvider.tsx`) (NEW)
- Глобальный провайдер для toast уведомлений
- Интегрирован в `src/app/layout.tsx`
- Настройки: позиция top-right, длительность 3 секунды, темная тема

### `LoadingSpinner` (`src/components/LoadingSpinner.tsx`) (NEW)
- Компонент для отображения спиннера загрузки
- Варианты размера и цвета
- Используется в reports page

### `SkeletonLoader` (`src/components/SkeletonLoader.tsx`) (NEW)
- Компонент для skeleton loading состояний
- Анимация pulse
- Настраиваемое количество элементов

### `ProgressBar` (`src/components/ProgressBar.tsx`) (NEW)
- Визуализация прогресса по текущему значению и цели
- Цветовая индикация на основе процента выполнения
- Используется в dashboard и nutrition

### `WeightChart` (`src/components/charts/WeightChart.tsx`) (NEW)
- Линейный график динамики веса
- Трендовая линия (линейная регрессия)
- Фильтр по периоду
- Использует библиотеку `recharts`

### `MacrosChart` (`src/components/charts/MacrosChart.tsx`) (NEW)
- График калорий с целевой линией
- График макронутриентов с целевыми линиями
- Фильтр по периоду
- Использует библиотеку `recharts`

### `ExportButton` (`src/components/reports/ExportButton.tsx`) (NEW)
- Кнопка экспорта данных
- Поддержка форматов: CSV, JSON, PDF
- Toast уведомления об успехе/ошибке

### `ReportFilters` (`src/components/reports/ReportFilters.tsx`) (NEW)
- Фильтры для reports page
- Фильтрация по дате, типу дня, сортировка
- Сброс фильтров

### `Pagination` (`src/components/Pagination.tsx`) (NEW)
- Компонент пагинации для больших списков
- Навигация по страницам с многоточием
- Отображение информации о текущей странице

### `SubscriptionBanner` (`src/components/SubscriptionBanner.tsx`)
- *Без изменений в v4.0*

### `NotificationSettings` (`src/components/NotificationSettings.tsx`)
- *Без изменений в v4.0*

### `ValidationWarning` (`src/components/ValidationWarning.tsx`)
- *Без изменений в v4.0*

### `DayToggle` (`src/components/DayToggle.tsx`)
- *Без изменений в v4.0*

### `Paywall` (`src/components/Paywall.tsx`)
- *Без изменений в v4.0*

### `ClientDashboardView` (`src/components/ClientDashboardView.tsx`)
- *Без изменений в v4.0*

---

## Утилиты

### `src/utils/export.ts` (NEW)
- `exportToCSV(data, filename)`: Экспорт данных в CSV формат
- `exportToJSON(data, filename)`: Экспорт данных в JSON формат
- `exportToPDF(dailyLogs, nutritionTargets, filename)`: Экспорт данных в PDF формат

### `src/utils/supabase/subscription.ts`
- *Без изменений в v4.0*

### `src/utils/validation/nutrition.ts`
- *Без изменений в v4.0*

### `src/utils/supabase/server.ts`
- *Без изменений в v4.0*

---

## API Routes

### `/api/nutrition-targets/update`
- *Без изменений в v4.0*

---

## Примечания

1. **Toast уведомления:** Все `alert()` заменены на `toast.error()` и `toast.success()` для лучшего UX

2. **Loading индикаторы:** Spinner и SkeletonLoader используются для визуальной обратной связи при загрузке данных

3. **ProgressBar:** Визуализация прогресса по КБЖУ улучшает понимание выполнения целей

4. **Графики:** WeightChart и MacrosChart предоставляют визуальное представление данных для лучшего анализа

5. **Экспорт данных:** CSV, JSON, PDF экспорт позволяет пользователям сохранять свои данные

6. **Фильтры и пагинация:** Улучшают навигацию по большим спискам данных

7. **Оптимистичные обновления:** Мгновенное обновление UI улучшает воспринимаемую производительность

8. **Зависимости:** Добавлены новые зависимости: `react-hot-toast`, `recharts`, `papaparse`, `jspdf`, `jspdf-autotable`

---

*Документ создан: декабрь 2025 (на основе текущей реализации в коде v4.0)*

