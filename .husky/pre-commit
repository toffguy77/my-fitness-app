#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_WEB_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^apps/web/" || true)
STAGED_API_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^apps/api/" || true)

# Frontend checks
if [ -n "$STAGED_WEB_FILES" ]; then
  echo "\nüì¶ Frontend checks..."

  # Type check only changed files
  echo "  ‚ö° Type checking..."
  cd apps/web && npx tsc --noEmit || exit 1
  cd ../..

  # Lint staged files
  echo "  ‚ö° Linting..."
  echo "$STAGED_WEB_FILES" | xargs npx eslint --max-warnings=0 || exit 1

  # Run tests related to changed files
  echo "  ‚ö° Running tests..."
  cd apps/web && npm test -- --bail --findRelatedTests $(echo "$STAGED_WEB_FILES" | sed 's|apps/web/||g') || exit 1
  cd ../..
fi

# Backend checks
if [ -n "$STAGED_API_FILES" ]; then
  echo "\nüîß Backend checks..."

  # Format check
  echo "  ‚ö° Format checking..."
  cd apps/api && go fmt ./... || exit 1
  cd ../..

  # Run tests for changed packages
  echo "  ‚ö° Running tests..."
  CHANGED_PACKAGES=$(echo "$STAGED_API_FILES" | sed 's|apps/api/||g' | xargs -I {} dirname {} | sort -u | sed 's|^|./|' | tr '\n' ' ')
  if [ -n "$CHANGED_PACKAGES" ]; then
    cd apps/api && go test $CHANGED_PACKAGES -short || exit 1
    cd ../..
  fi
fi

echo "\n‚úÖ Pre-commit checks passed!"
