# Requirements Document: Chat Realtime Fix

## Introduction

Исправление критической ошибки в системе чата, из-за которой тренеры не видят сообщения от клиентов в real-time режиме.

## Glossary

- **Chat_System**: Система обмена сообщениями между тренерами и клиентами
- **Realtime_Subscription**: WebSocket подписка на обновления сообщений через Supabase Realtime
- **Message_Filter**: Фильтр для получения сообщений в Supabase Realtime
- **Coach**: Тренер, который должен видеть сообщения от клиентов
- **Client**: Клиент, отправляющий сообщения тренеру

## Requirements

### Requirement 1: Исправление Realtime фильтров

**User Story:** Как тренер, я хочу видеть сообщения от клиентов в реальном времени, чтобы оперативно отвечать на их вопросы.

#### Acceptance Criteria

1. WHEN тренер открывает чат с клиентом, THE Chat_System SHALL загружать все сообщения между тренером и клиентом из базы данных
2. WHEN клиент отправляет новое сообщение, THE Realtime_Subscription SHALL уведомить тренера о новом сообщении в течение 5 секунд
3. WHEN тренер отправляет сообщение клиенту, THE Realtime_Subscription SHALL уведомить клиента о новом сообщении в течение 5 секунд
4. THE Message_Filter SHALL фильтровать сообщения по отправителю и получателю
5. THE Chat_System SHALL отображать сообщения в хронологическом порядке по времени создания

### Requirement 2: Улучшение обработки ошибок в чате

**User Story:** Как разработчик, я хочу видеть ошибки в системе чата, чтобы быстро диагностировать проблемы.

#### Acceptance Criteria

1. WHEN происходит ошибка загрузки сообщений, THE Chat_System SHALL логировать тип ошибки, сообщение об ошибке и временную метку
2. WHEN Realtime подписка не работает, THE Chat_System SHALL показать пользователю уведомление о проблеме подключения
3. WHEN отправка сообщения не удается, THE Chat_System SHALL показать сообщение об ошибке отправки и предоставить возможность повторить отправку
4. THE Chat_System SHALL отклонять пустые сообщения перед отправкой
5. THE Chat_System SHALL отклонять сообщения длиннее 5000 символов перед отправкой

### Requirement 3: Автоматизированное тестирование чата

**User Story:** Как QA инженер, я хочу иметь автоматические тесты для чата, чтобы предотвратить регрессии.

#### Acceptance Criteria

1. THE Chat_System SHALL иметь автоматические тесты для проверки корректности отображения сообщений
2. THE Message_Filter SHALL иметь автоматические тесты для проверки корректности фильтрации по отправителю и получателю
3. THE Chat_System SHALL иметь автоматические тесты для проверки успешной отправки и получения сообщений между пользователями
4. THE Chat_System SHALL иметь автоматические тесты для проверки полного сценария обмена сообщениями между тренером и клиентом
5. THE Chat_System SHALL иметь автоматические тесты для проверки обработки ошибок подключения и отправки
