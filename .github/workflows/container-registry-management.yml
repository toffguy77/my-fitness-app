name: Container Registry Management

on:
  schedule:
    # Run cleanup weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'Type of cleanup to perform'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - aggressive
          - dry-run
      keep_versions:
        description: 'Number of versions to keep'
        required: false
        default: '10'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  registry-cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set cleanup parameters
        id: params
        run: |
          case "${{ github.event.inputs.cleanup_type || 'standard' }}" in
            "standard")
              echo "keep_versions=10" >> $GITHUB_OUTPUT
              echo "dry_run=false" >> $GITHUB_OUTPUT
              ;;
            "aggressive")
              echo "keep_versions=5" >> $GITHUB_OUTPUT
              echo "dry_run=false" >> $GITHUB_OUTPUT
              ;;
            "dry-run")
              echo "keep_versions=10" >> $GITHUB_OUTPUT
              echo "dry_run=true" >> $GITHUB_OUTPUT
              ;;
          esac
          
          # Override with manual input if provided
          if [ -n "${{ github.event.inputs.keep_versions }}" ]; then
            echo "keep_versions=${{ github.event.inputs.keep_versions }}" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up old container images
        uses: actions/delete-package-versions@v4
        with:
          package-name: ${{ github.event.repository.name }}
          package-type: 'container'
          min-versions-to-keep: ${{ steps.params.outputs.keep_versions }}
          delete-only-untagged-versions: false

      - name: Clean up untagged images
        uses: actions/delete-package-versions@v4
        with:
          package-name: ${{ github.event.repository.name }}
          package-type: 'container'
          min-versions-to-keep: 0
          delete-only-untagged-versions: true

      - name: Generate cleanup report
        run: |
          cat > cleanup-report.md << EOF
          # Container Registry Cleanup Report
          
          **Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Cleanup Type:** ${{ github.event.inputs.cleanup_type || 'standard' }}
          **Versions Kept:** ${{ steps.params.outputs.keep_versions }}
          **Dry Run:** ${{ steps.params.outputs.dry_run }}
          
          ## Actions Taken
          
          - Cleaned up old container image versions
          - Removed untagged images
          - Kept the ${{ steps.params.outputs.keep_versions }} most recent versions
          
          ## Registry Information
          
          - **Registry:** ${{ env.REGISTRY }}
          - **Image:** ${{ env.IMAGE_NAME }}
          - **Cleanup Frequency:** Weekly (Sundays at 2 AM UTC)
          
          ## Storage Benefits
          
          This cleanup helps:
          - Reduce storage costs
          - Improve registry performance
          - Maintain organization
          - Keep only relevant versions
          
          EOF

      - name: Upload cleanup report
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-report-${{ github.run_number }}
          path: cleanup-report.md
          retention-days: 30

  registry-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Audit registry usage
        run: |
          echo "# Registry Audit Report" > registry-audit.md
          echo "" >> registry-audit.md
          echo "**Date:** $(date)" >> registry-audit.md
          echo "**Repository:** ${{ github.repository }}" >> registry-audit.md
          echo "" >> registry-audit.md
          
          # Get package information using GitHub API
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}" \
            --jq '{
              name: .name,
              package_type: .package_type,
              visibility: .visibility,
              created_at: .created_at,
              updated_at: .updated_at
            }' > package-info.json
          
          echo "## Package Information" >> registry-audit.md
          echo "" >> registry-audit.md
          echo "- **Name:** $(jq -r '.name' package-info.json)" >> registry-audit.md
          echo "- **Type:** $(jq -r '.package_type' package-info.json)" >> registry-audit.md
          echo "- **Visibility:** $(jq -r '.visibility' package-info.json)" >> registry-audit.md
          echo "- **Created:** $(jq -r '.created_at' package-info.json)" >> registry-audit.md
          echo "- **Updated:** $(jq -r '.updated_at' package-info.json)" >> registry-audit.md
          echo "" >> registry-audit.md
          
          # Get version count
          VERSION_COUNT=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions" \
            --jq 'length')
          
          echo "## Version Statistics" >> registry-audit.md
          echo "" >> registry-audit.md
          echo "- **Total Versions:** ${VERSION_COUNT}" >> registry-audit.md
          echo "" >> registry-audit.md
          
          # List recent versions
          echo "## Recent Versions" >> registry-audit.md
          echo "" >> registry-audit.md
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions" \
            --jq 'sort_by(.created_at) | reverse | .[0:10] | .[] | "- **" + (.metadata.container.tags[0] // "untagged") + "** (Created: " + .created_at + ")"' \
            >> registry-audit.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: registry-audit-${{ github.run_number }}
          path: registry-audit.md
          retention-days: 90

  tag-strategy-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate tagging strategy
        run: |
          echo "# Tag Strategy Validation Report" > tag-validation.md
          echo "" >> tag-validation.md
          echo "**Date:** $(date)" >> tag-validation.md
          echo "" >> tag-validation.md
          
          # Run tagging strategy script to generate tags
          ./scripts/docker-tagging-strategy.sh my-fitness-app ghcr.io ${{ github.repository }} generate-tags > generated-tags.txt
          
          echo "## Generated Tags" >> tag-validation.md
          echo "" >> tag-validation.md
          echo "\`\`\`" >> tag-validation.md
          cat generated-tags.txt >> tag-validation.md
          echo "\`\`\`" >> tag-validation.md
          echo "" >> tag-validation.md
          
          # Validate tag format
          echo "## Tag Validation" >> tag-validation.md
          echo "" >> tag-validation.md
          
          VALID_TAGS=0
          INVALID_TAGS=0
          
          while IFS= read -r tag; do
            if [[ "$tag" =~ ^[a-z0-9._/-]+:[a-zA-Z0-9._-]+$ ]]; then
              VALID_TAGS=$((VALID_TAGS + 1))
            else
              INVALID_TAGS=$((INVALID_TAGS + 1))
              echo "- ❌ Invalid tag format: \`$tag\`" >> tag-validation.md
            fi
          done < generated-tags.txt
          
          echo "- ✅ Valid tags: $VALID_TAGS" >> tag-validation.md
          echo "- ❌ Invalid tags: $INVALID_TAGS" >> tag-validation.md
          
          if [ $INVALID_TAGS -gt 0 ]; then
            echo "Tag validation failed with $INVALID_TAGS invalid tags"
            exit 1
          fi

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: tag-validation-${{ github.run_number }}
          path: tag-validation.md
          retention-days: 30