name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to rollback to (commit SHA or tag)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

jobs:
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application for rollback
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ github.event.inputs.environment == 'production' && secrets.NEXT_PUBLIC_SUPABASE_URL || secrets.STAGING_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ github.event.inputs.environment == 'production' && secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || secrets.STAGING_SUPABASE_ANON_KEY }}
      
      - name: Send rollback start notification
        run: |
          node scripts/telegram-notify.js deployment ${{ github.event.inputs.environment }} rollback_start ${{ github.event.inputs.version }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      - name: Perform rollback
        id: rollback
        run: |
          echo "ðŸ”„ Starting rollback to version ${{ github.event.inputs.version }}"
          echo "ðŸŒ Environment: ${{ github.event.inputs.environment }}"
          echo "ðŸ“ Reason: ${{ github.event.inputs.reason }}"
          
          # Store current version for potential re-rollback
          CURRENT_VERSION=$(git rev-parse HEAD)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Placeholder for actual rollback deployment
          # In real implementation, this would:
          # 1. Deploy the specified version to the environment
          # 2. Update load balancer/CDN configuration
          # 3. Update database migrations if needed (with caution)
          # 4. Clear caches
          
          # Simulate rollback deployment
          echo "ðŸ“¦ Deploying version ${{ github.event.inputs.version }} to ${{ github.event.inputs.environment }}..."
          sleep 10
          
          # Set deployment URL based on environment
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "deployment_url=https://myfitnessapp.com" >> $GITHUB_OUTPUT
          else
            echo "deployment_url=https://staging.myfitnessapp.com" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… Rollback deployment completed"
      
      - name: Run post-rollback health checks
        run: |
          echo "ðŸ” Running post-rollback health checks..."
          
          # Enhanced health checks for rollback
          # In real implementation, this would:
          # 1. Check all critical endpoints
          # 2. Verify database connectivity
          # 3. Test authentication flows
          # 4. Check monitoring systems
          # 5. Verify no data corruption occurred
          
          # Simulate comprehensive health checks
          sleep 15
          
          echo "âœ… All post-rollback health checks passed"
          echo "ðŸŽ¯ Application is stable on version ${{ github.event.inputs.version }}"
      
      - name: Create rollback audit record
        run: |
          echo "ðŸ“‹ Creating rollback audit record..."
          
          # Create rollback record for tracking
          cat > rollback-record.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "environment": "${{ github.event.inputs.environment }}",
            "from_version": "${{ steps.rollback.outputs.current_version }}",
            "to_version": "${{ github.event.inputs.version }}",
            "reason": "${{ github.event.inputs.reason }}",
            "initiated_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}",
            "deployment_url": "${{ steps.rollback.outputs.deployment_url }}"
          }
          EOF
          
          echo "ðŸ“‹ Rollback record created:"
          cat rollback-record.json
      
      - name: Send rollback success notification
        if: success()
        run: |
          node scripts/telegram-notify.js deployment ${{ github.event.inputs.environment }} rollback_success ${{ github.event.inputs.version }} ${{ steps.rollback.outputs.deployment_url }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      - name: Send rollback failure notification
        if: failure()
        run: |
          node scripts/telegram-notify.js deployment ${{ github.event.inputs.environment }} rollback_failure ${{ github.event.inputs.version }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      - name: Upload rollback artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rollback-record-${{ github.event.inputs.environment }}-${{ github.run_id }}
          path: rollback-record.json
          retention-days: 90

  post-rollback-monitoring:
    name: Post-Rollback Monitoring
    runs-on: ubuntu-latest
    needs: rollback
    if: success()
    steps:
      - name: Setup monitoring
        run: |
          echo "ðŸ” Setting up enhanced monitoring for 30 minutes post-rollback..."
          
          # In real implementation, this would:
          # 1. Enable enhanced monitoring alerts
          # 2. Set up temporary dashboards
          # 3. Schedule automated health checks
          # 4. Alert on-call team
          
          echo "âœ… Enhanced monitoring activated"
      
      - name: Schedule monitoring report
        run: |
          echo "ðŸ“Š Scheduling 30-minute monitoring report..."
          
          # In real implementation, this would schedule a follow-up job
          # to check system stability and send a report
          
          echo "â° Monitoring report scheduled"