# Security Configuration for CI/CD Pipeline
# This file defines security policies and access controls for the repository

security:
  # Secrets management configuration
  secrets:
    # Required secrets for CI/CD operations
    required:
      - name: GITHUB_TOKEN
        type: automatic
        description: "GitHub Actions token (automatically provided)"
        access_level: repository
        rotation_required: false

      - name: NEXT_PUBLIC_SUPABASE_URL
        type: environment
        description: "Supabase project URL (public)"
        access_level: public
        rotation_required: false

      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        type: environment
        description: "Supabase anonymous key (public)"
        access_level: public
        rotation_required: true
        rotation_frequency: quarterly

      - name: STAGING_SUPABASE_URL
        type: environment
        description: "Staging Supabase project URL"
        access_level: staging
        rotation_required: false

      - name: STAGING_SUPABASE_ANON_KEY
        type: environment
        description: "Staging Supabase anonymous key"
        access_level: staging
        rotation_required: true
        rotation_frequency: quarterly

      - name: TELEGRAM_BOT_TOKEN
        type: notification
        description: "Telegram bot token for CI/CD notifications"
        access_level: ci_cd
        rotation_required: true
        rotation_frequency: annually

      - name: TELEGRAM_CHAT_ID
        type: notification
        description: "Telegram chat ID for notifications"
        access_level: ci_cd
        rotation_required: false

    # Optional secrets for enhanced functionality
    optional:
      - name: CODECOV_TOKEN
        type: integration
        description: "Codecov token for coverage reporting"
        access_level: ci
        rotation_required: true
        rotation_frequency: annually

      - name: SONAR_TOKEN
        type: integration
        description: "SonarQube token for code quality analysis"
        access_level: ci
        rotation_required: true
        rotation_frequency: annually

      - name: SNYK_TOKEN
        type: security
        description: "Snyk token for security scanning"
        access_level: ci
        rotation_required: true
        rotation_frequency: annually

  # Access control policies
  access_control:
    # Workflow permissions
    workflows:
      ci:
        permissions:
          contents: read
          security-events: write
          actions: read
        secrets_access:
          - GITHUB_TOKEN
          - NEXT_PUBLIC_SUPABASE_URL
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - CODECOV_TOKEN
          - SONAR_TOKEN
          - SNYK_TOKEN

      cd:
        permissions:
          contents: read
          packages: write
          deployments: write
        secrets_access:
          - GITHUB_TOKEN
          - NEXT_PUBLIC_SUPABASE_URL
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - STAGING_SUPABASE_URL
          - STAGING_SUPABASE_ANON_KEY
          - TELEGRAM_BOT_TOKEN
          - TELEGRAM_CHAT_ID

      security:
        permissions:
          contents: read
          security-events: write
          issues: write
        secrets_access:
          - GITHUB_TOKEN
          - TELEGRAM_BOT_TOKEN
          - TELEGRAM_CHAT_ID

    # Environment-based access
    environments:
      staging:
        required_reviewers: 0
        secrets:
          - STAGING_SUPABASE_URL
          - STAGING_SUPABASE_ANON_KEY
          - TELEGRAM_BOT_TOKEN
          - TELEGRAM_CHAT_ID

      production:
        required_reviewers: 1
        secrets:
          - NEXT_PUBLIC_SUPABASE_URL
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - TELEGRAM_BOT_TOKEN
          - TELEGRAM_CHAT_ID

  # Security scanning configuration
  scanning:
    # Dependency scanning
    dependencies:
      enabled: true
      schedule: "daily"
      severity_threshold: "high"
      auto_fix: false

    # Code scanning
    code:
      enabled: true
      languages: ["javascript", "typescript"]
      queries: "security-and-quality"
      schedule: "weekly"

    # Container scanning
    containers:
      enabled: true
      registries: ["ghcr.io"]
      severity_threshold: "critical"

    # Secret scanning
    secrets:
      enabled: true
      push_protection: true
      validity_checks: true

  # Compliance and audit
  compliance:
    # Audit logging
    audit:
      enabled: true
      retention_days: 90
      events:
        - secret_access
        - workflow_execution
        - deployment
        - security_scan

    # Reporting
    reporting:
      frequency: "weekly"
      recipients: ["security-team"]
      include:
        - secrets_audit
        - vulnerability_summary
        - compliance_status

  # Incident response
  incident_response:
    # Automated responses
    automation:
      secret_leak:
        action: "revoke_and_notify"
        notification_channels: ["telegram", "github_issue"]

      critical_vulnerability:
        action: "block_deployment"
        notification_channels: ["telegram", "github_issue"]

      failed_security_scan:
        action: "block_merge"
        notification_channels: ["github_status"]

    # Escalation procedures
    escalation:
      levels:
        - level: 1
          trigger: "high_severity_vulnerability"
          action: "notify_team"
          timeout: "4h"

        - level: 2
          trigger: "critical_vulnerability"
          action: "notify_security_team"
          timeout: "1h"

        - level: 3
          trigger: "secret_leak"
          action: "emergency_response"
          timeout: "15m"

# Security best practices enforcement
best_practices:
  # Secrets management
  secrets:
    - "Use GitHub Secrets for all sensitive data"
    - "Never commit secrets to repository"
    - "Rotate secrets regularly according to schedule"
    - "Use environment-specific secrets"
    - "Limit secret access to necessary workflows"

  # Access control
  access:
    - "Use least privilege principle"
    - "Require reviews for production deployments"
    - "Use environment protection rules"
    - "Monitor and audit access patterns"

  # Scanning and monitoring
  monitoring:
    - "Enable all security scanning features"
    - "Set appropriate severity thresholds"
    - "Monitor scan results regularly"
    - "Respond to security alerts promptly"

  # Incident response
  response:
    - "Have clear escalation procedures"
    - "Automate initial response actions"
    - "Document all security incidents"
    - "Conduct post-incident reviews"
